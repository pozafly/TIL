# 0.9 Stub

#Testing #Jest #Mock #Stub

[Repo](https://github.com/pozafly/Jest-Example), [Mock](https://jestjs.io/docs/mock-functions), [Mock í•¨ìˆ˜ ì°¸ê³ ](https://www.daleseo.com/jest-fn-spy-on/)

## Mock & Stub ì°¨ì´ì 

Stubì´ë€, ì „ì²´ ì¤‘ ì¼ë¶€ë¼ëŠ” ëœ». ëª¨ë“  ê¸°ëŠ¥ ëŒ€ì‹  ì¼ë¶€ ê¸°ëŠ¥ì— ì§‘ì¤‘í•´ ì„ì˜ë¡œ êµ¬í˜„í•œë‹¤.

- Mock: êµ¬í˜„ ì‚¬í•­ì´ ì—†ê³  ì§„ì§œì¸ë“¯í•œ ê°’ì„ ë°˜í™˜.
- Stub: ì‹¤ì œ ì¸í„°í˜ì´ìŠ¤ì˜ êµ¬í˜„ì²´ë¥¼ êµ¬í˜„í•´ ì§„ì§œì™€ ëŒ€ì²´ ê°€ëŠ¥í•œ ê²ƒì„ ë§í•¨.

### êµ¬í˜„

```js
// no dipendency ë‚˜ìœ ë²„ì „ì„.
const ProductClient = require('./product_client.js');

class ProductService {
  constructor() {
    this.productClient = new ProductClient();
  }

  fetchAvailableItems() {
    return this.productClient
      .fetchItems()
      .then((items) => items.filter((item) => item.available));
  }
}

module.exports = ProductService;
```

ì´ ì½”ë“œë¥¼ ë³´ë©´, constuctorë¡œ dië¥¼ í•˜ê³  ìˆë‹¤. class ë‚´ë¶€ì—ì„œ ì˜ì¡´ì„ ì •ì˜ í•˜ëŠ” ê²ƒì€ dependency injectionì˜ ì›ì¹™ì— ì–´ê¸‹ë‚œë‹¤(constructor ë‚´ë¶€). ê·œì¹™ì— ë§ê²Œ ì‘ì„±í•œë‹¤ë©´(ì¢‹ì€ ì½”ë“œëŠ”), ì˜ì¡´ì„±ì„ ì™¸ë¶€ì—ì„œ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ë‹¤.

```js
class ProductService {
  constructor(productClient) {
    this.productClient = productClient;
  }

  (...)
}

```

require ë¬¸ì„ ì—†ì•´ê³ , contructorì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°›ëŠ” í˜•íƒœë¡œ ë°”ë€Œì—ˆë‹¤. ì¦‰, ì–´ë–¤ ëª¨ë“ˆì´ ì™¸ë¶€ë¡œ ë¶€í„° ì£¼ì…ë°›ëŠ” í˜•íƒœë¥¼ IoC(ì œì–´ì˜ ì—­ì „) ì´ë¼ê³  í•¨.

ì´ì ì€, test í•  ë•ŒëŠ” productClientë¥¼ testì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¸ìë¡œ ì£¼ì…í•˜ë©´ ë˜ê³ , ì‹¤ì œ í”„ë¡œí„±íŠ¸ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì£¼ì…í•˜ë©´ ëœë‹¤.

test í´ë” ì•ˆì— stub_product_client.js íŒŒì¼ì„ ë§Œë“¤ì. test í´ë” ë‚´ë¶€ì— ë‘ëŠ” ì´ìœ ëŠ” í”„ë¡œë•ì…˜ ì½”ë“œê°€ ì•„ë‹ˆê¸° ë•Œë¬¸ì´ë‹¤.

```js
// stub_product_client.js
class StubProductClient {
  async fetchItems() {
    return [
      { item: 'ğŸ¥›', available: true },
      { item: 'ğŸŒ', available: false },
    ];
  }
}

module.exports = StubProductClient;
```

StubProductClient classëŠ”, ì‹¤ì œ ProductClientì˜ fetchItems() ë¼ëŠ” ë©”ì„œë“œë¥¼ ê·¸ëŒ€ë¡œ ê°€ì§€ê³  ìˆë‹¤. ì¦‰, ì¸í„°í˜ì´ìŠ¤ëŠ” ë™ì¼í•˜ë‹¤. ë„¤íŠ¸ì›Œí¬ì— ì ˆëŒ€ ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ì½”ë“œì´ë‹¤.

```js
// product_service_test.js
const ProductService = require('../product_service.js');
const StubProductClient = require('./stub_product_client.js');

describe('ProductService - Stub', () => {
  let productService;

  beforeEach(() => {
    productService = new ProductService(new StubProductClient());
  });

  it('should filter out only available items', async () => {
    const items = await productService.fetchAvailableItems();
    expect(items.length).toBe(1);
    expect(items).toEqual([{ item: 'ğŸ¥›', available: true }]);
  });
});
```

product_service_test.js ë¥¼ ë§Œë“¤ì–´ì„œ stubì„ í…ŒìŠ¤íŠ¸ í•´ë³´ì. ProductService ìƒì„±ìì— StubProductClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì„œ ë„£ì–´ì£¼ì—ˆë‹¤. ê·¸ëŸ¬ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì •ìƒì ìœ¼ë¡œ í†µê³¼í•œë‹¤.

ë•Œì— ë”°ë¼ Mock, Stub ì¤‘ Stubì´ ë¬´ì¡°ê±´ ì¢‹ì€ ê²ƒì€ ì•„ë‹ˆë‹¤. ì ì ˆí•˜ê²Œ ë‚˜ëˆ„ì–´ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## Stub ëŒ€ì‹  Mockì„ í…ŒìŠ¤íŠ¸ í•´ì•¼í•  ê²½ìš°

functionì„ í˜¸ì¶œ í–ˆëŠ”ì§€, ì•ˆí–ˆëŠ”ì§€(í–‰ìœ„)ë¥¼ í…ŒìŠ¤íŠ¸ í•  ê²½ìš° Stubì„ ì‚¬ìš©í•  ê²½ìš° ë¬´ë¦¬ê°€ ì¡´ì¬í•¨.

```js
class UserService {
  constructor(userClient) {
    this.userClient = userClient;
    this.isLogedIn = false;
  }

  login(id, password) {
    if (!this.isLogedIn) {
      return this.userClient
        .login(id, password) //
        .then((data) => (this.isLogedIn = true));
    }
  }
}
```

ìœ„ì™€ ê°™ì€ ë¡œì§ì€ userClientì˜ methodì¸ login ë©”ì„œë“œê°€ ì‹¤í–‰ ë˜ì—ˆëŠ”ì§€? ê·¸ë¦¬ê³ , ì´ë¯¸ ë¡œê·¸ì¸ì´ ëœ ìƒí™©ì´ë¼ë©´, login ë©”ì„œë“œëŠ” ì‹¤í–‰ë˜ë©´ ì•ˆëœë‹¤ëŠ” ì˜ë¯¸ë¥¼ ê°€ì§€ê³  ìˆëŠ” ë©”ì„œë“œë‹¤.

í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ìœ„í•´ Stubìœ¼ë¡œë¶€í„° dataë¥¼ return í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°€ì§„ë‹¤ë©´, loginì´ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸ í•˜ê¸° ì–´ë µë‹¤. ë”°ë¼ì„œ, mockì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ìƒí™©ì´ë‹¤. í…ŒìŠ¤íŠ¸ í•´ë³´ì.

```js
const UserService = require('../user_service');
const UserClient = require('../user_client');
jest.mock('../user_client');

describe('UserService', () => {
  const login = jest.fn(async () => 'success');
  UserClient.mockImplementation(() => {
    return {
      login,
    };
  });
  let userService;

  beforeEach(() => {
    userService = new UserService(new UserClient());
  });

  it('calls login() on UserClient when tries to login', async () => {
    await userService.login('abc', 'abc');
    expect(login.mock.calls.length).toBe(1);
  });

  it('should not call login() on UserClient again if already logged in', async () => {
    await userService.login('abc', 'abc');
    await userService.login('abc', 'abc');

    expect(login.mock.calls.length).toBe(1);
  });
});
```

`await userService.login('abc', 'abc');` ê°€ í•œë²ˆ ì‹¤í–‰ë˜ì—ˆì„ ë•ŒëŠ”, login ë©”ì„œë“œê°€ 1ë²ˆë§Œ ì‹¤í–‰ë˜ì—ˆê³ , ë‘ë²ˆ ì‹¤í–‰ë˜ì—ˆì„ ë•Œë„ login ë©”ì„œë“œëŠ” í•œë²ˆë§Œ ì‹¤í–‰ë˜ì—ˆë‹¤. ì˜ë„ëŒ€ë¡œ ì˜ ëœê²ƒì„.
