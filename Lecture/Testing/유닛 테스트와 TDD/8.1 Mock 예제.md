#Testing #Jest #Mock

[Repo](https://github.com/pozafly/Jest-Example), [Mock](https://jestjs.io/docs/mock-functions)

ì´ë²ˆ ì½”ë“œëŠ” Mockì„ ì“¸ë° ì—†ì´ ë§ì´ ì‚¬ìš©í•´ ë‚¨ìš©í•˜ëŠ” ì‚¬ë¡€ë¥¼ ì‚´í´ë³´ì.

---

ë°±ì—”ë“œë¡œë¶€í„° ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í•¨ìˆ˜ë¥¼ í†µê³¼í•˜ëŠ” ë¡œì§ì´ ìˆë‹¤ê³  í•˜ì. 

```js
// product_client.js
class ProductClient {
  fetchItems() {
    return fetch('http://example.com/login/id+password').then((response) => {
      response.json();
    });
  }
}

module.exports = ProductClient;
```

```js
// product_service_no_di.js
const ProductClient = require('./product_client.js');

class ProductService {
  constructor() {
    this.productClient = new ProductClient();
  }

  fetchAvailableItems() {
    return this.productClient
      .fetchItems()
      .then((items) => items.filter((item) => item.available));
  }
}

module.exports = ProductService;
```

ìš°ë¦¬ëŠ” ProductService classì˜ fetchAvailableItems ë©”ì„œë“œë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê³  ì‹¶ë‹¤ê³  í•˜ì. ì½”ë“œëŠ” ë‹¨ìˆœí•¨. ë°±ì—”ë“œ ë°ì´í„°ë¥¼ fetch ë°›ì•„ì™€ì„œ, filter apië¡œ ì‚¬ìš©ê°€ëŠ¥í•œ ëª©ë¡ë§Œ ë½‘ì•„ë‚´ëŠ” ì—­í• ì„ í•¨.

```js
// product_service_no_di.test.js
const ProductService = require('../product_service_no_di.js');
const ProductClient = require('../product_client.js');

describe('ProductService', () => {
  let productService;

  beforeEach(() => {
    productService = new ProductService();
  });

  it('', () => {});
});
```
ì´ë ‡ê²Œ í…ŒìŠ¤íŠ¸ í•  í™˜ê²½ì„ ë§Œë“¤ì—ˆë‹¤. beforeEachì— productService ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§¤ë²ˆ ë§Œë“¤ì–´ ì£¼ê³  ìˆëŠ”ë°, 
ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ëŠ” ëª¨ë“ˆ ê°„ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ëŠ”ê²Œ ì•„ë‹Œ, í•˜ë‚˜ì˜ ë‹¨ìœ„ë¥¼ í…ŒìŠ¤íŠ¸ í•´ì•¼í•˜ëŠ”ë° ì§€ê¸ˆì€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê²Œ ë˜ë©´ì„œ ë¬¶ì—¬ìˆëŠ” ëª¨ë“ˆì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ” ì´ìŠˆê°€ ìˆë‹¤.
ì˜ëª»ëœ í…ŒìŠ¤íŠ¸ì¸ ê²ƒì„.

ProductClient ì— ìˆëŠ” fetch í•¨ìˆ˜ë„ ìš°ë¦¬ë„ ëª¨ë¥´ê²Œ ìš”ì²­ë˜ê³  ìˆëŠ” ìƒíƒœì„. ì´ë ‡ê²Œ ë„¤íŠ¸ì›Œí¬ ìƒíƒœì— ì˜ì¡´í•˜ëŠ” ì½”ë“œëŠ” ì¢‹ì§€ ì•Šì€ ì½”ë“œì„.

ë”°ë¼ì„œ, **ProductClient ìì²´ë¥¼ Mocking** í•˜ë©´ ëœë‹¤.

```js
const ProductService = require('../product_service_no_di.js');
const ProductClient = require('../product_client.js');

// jestì—ê²Œ product_clientë¥¼ mock í•  ê²ƒì´ë¼ê³  ëª…ì‹œ
jest.mock('../product_client.js');

describe('ProductService', () => {
  // fetchItemsë¼ëŠ” mock í•¨ìˆ˜ëŠ” ë¹„ë™ê¸°ë¡œ listë¥¼ return í•œë‹¤.
  const fetchItems = jest.fn(async () => [
    { item: 'ğŸ¥›', available: true },
    { item: 'ğŸŒ', available: false },
  ]);

  // ProductClientë¥¼ ì„ì‹œë¡œ ëª¨í‚¹í•  ê²ƒì´ë‹¤.
  // return ë¬¸ ì•ˆì—ëŠ” ì–´ë–¤ ë©”ì„œë“œë¥¼ ì–´ë–¤ ì´ë¦„ìœ¼ë¡œ mocking í•  ê²ƒì¸ê°€ ëª…ì‹œí•´ì¤Œ.
  ProductClient.mockImplementation(() => {
    return {
      fetchItems,
    };
  });

  (...)
});

```

ì •ë¦¬í•˜ìë©´, 
- ProductClient classëŠ” ì˜ì¡´ì„±ì´ ìˆëŠ”ë°, ì´ ì˜ì¡´ì„±ì„ ëŠì–´ë‚´ê¸° ìœ„í•´ Mocking í•¨.
- ProductClient classì˜ ë©”ì„œë“œì¸ fetchItemsëŠ” jest.fn() ì„ ì´ìš©í•´ Mocking functionìœ¼ë¡œ ë§Œë“¤ì–´ì£¼ê³ , ì–´ë–¤ ê°’ì„ return í•  ê²ƒì¸ì§€ ëª…ì‹œ.
- describe ì•ˆì— ProductClientì˜ ì–´ë–¤ ê²ƒì„ Mocking í•´ì¤„ ê²ƒì¸ì§€ë¥¼ ëª…ì‹œ.

ì´ë ‡ê²Œ í–ˆì„ ê²½ìš° ì¥ì 
- í´ë¼ì´ì–¸íŠ¸ ë©”ì„œë“œê°€ ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ë˜ëŠ”, db ê°’ì„ ë³€ê²½ ë“±ì˜ ì‹¤ì œ í–‰ìœ„ê°€ ì¼ì–´ë‚˜ì§€ ì•ŠìŒ
	- ì¦‰, í™˜ê²½ì ì¸ ìš”ì¸ì— ì˜í–¥ì„ ë°›ì§€ ì•ŠìŒ.
- ë””íœë˜ì‹œë¥¼ ëŠê³  ë…ë¦½ì ì¸ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥.
	- ì›í•˜ëŠ” ë¡œì§ë§Œ ë‚ ì¹´ë¡­ê²Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥.


test ì „ì²´ ì½”ë“œë¥¼ ë³´ì
```js
const ProductService = require('../product_service_no_di.js');
const ProductClient = require('../product_client.js');

// jestì—ê²Œ product_clientë¥¼ mock í•  ê²ƒì´ë¼ê³  ëª…ì‹œ
jest.mock('../product_client.js');

describe('ProductService', () => {
  // fetchItemsë¼ëŠ” mock í•¨ìˆ˜ëŠ” ë¹„ë™ê¸°ë¡œ listë¥¼ return í•œë‹¤.
  const fetchItems = jest.fn(async () => [
    { item: 'ğŸ¥›', available: true },
    { item: 'ğŸŒ', available: false },
  ]);
  ProductClient.mockImplementation(() => {
    return {
      fetchItems,
    };
  });

  let productService;

  beforeEach(() => {
    productService = new ProductService();
  });

  it('should filter out only available items', async () => {
    const items = await productService.fetchAvailableItems(); // ë¹„ë™ê¸°ë¡œ ê°€ì ¸ì˜´
    expect(items.length).toBe(1); // itemì— ëŒ€í•´ test ê°€ëŠ¥
    expect(items).toEqual([{ item: 'ğŸ¥›', available: true }]);
  });
});
```

ì´ë²ˆì—” fetItems ê°€ ëª‡ë²ˆ í˜¸ì¶œ ë˜ì—ˆëŠ”ì§€ test í•´ë³´ì.
```js
it('test', async () => {
  const items = await productService.fetchAvailableItems();
  expect(fetchItems).toHaveBeenCalledTimes(1);
});
```
ì´ë ‡ê²Œ í•´ì£¼ë©´, í•œë²ˆ í˜¸ì¶œë˜ì—ˆë‹¤ê³  ì•Œ ìˆ˜ ìˆë‹¤.
jest.config.js íŒŒì¼ì— ë³´ë©´, `clearMocks: true` ì´ë ‡ê²Œ mock ëœ ê²ƒì„ clear í•˜ëŠ” ì„¤ì •ì´ ë˜ì–´ìˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆëŠ”ë° **false** ë¡œ ë°”ê¾¸ê²Œ ë˜ë©´, toHaveBeenCalledTimes ì—ëŠ” 2ë¥¼, ì¦‰ 2ë²ˆ í˜¸ì¶œ ë˜ì—ˆë‹¤ëŠ” test í•´ì•¼ pass ëœë‹¤.

ì´ìœ ëŠ” it ì´ 2ë²ˆì“°ì´ëŠ”ë° itì•ˆì—ì„œ fetchItemsë¥¼ ê°ê° í˜¸ì¶œ í–ˆê¸° ë•Œë¬¸ì„. ì´ê±¸ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ”
```js
beforeEach(() => {
  productService = new ProductService();
  fetchItems.mockClear(); // ğŸ”¥
  ProductClient.mockClear(); // ğŸ”¥
});
```
ğŸ”¥ ê³¼ ê°™ì´ clearë¥¼ í•´ì£¼ì–´ì•¼ í•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•˜ë‹¤.