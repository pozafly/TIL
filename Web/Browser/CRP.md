# CRP(Critical Rendering Path)

브라우저가 HTML, CSS, JavaScript를 화면에 픽셀로 변화하는 일련의 과정이다.

1. request / response
   - 웹서버에 html 요청, 반환 받음.
2. loading
   - html을 로딩함. html 파일 내부에서 필요한 리소스(이미지, CSS, JS)를 찾아 다운로드를 시작함.
3. scripting
   - html 파일을 파싱하면서 DOM 요소로 변환하여 DOM Tree를 생성, CSS 파일을 읽어 CSSOM 트리를 생성한다.
4. rendering
   - DOM 트리와 CSSOM 트리를 결합해 브라우저에 표기될 요소들인 Render Tree를 생성한다.
5. layout
   - 렌더 트리의 각 요소들의 위치와 크기를 계산하는 과정이 일어난다.
     - 예를 들면, width가 50%인 요소가 있다고 하면, 뷰포트가 600px -> 300px로 계산되는 과정이 이 과정이다.
6. painting
   - 각 레이어별로 실제 그리기 작업을 수행하는 과정.
     - 이전 레이아웃 단계에서 계산된 값을 이용해 렌더트리의 각 노드를 화면상 실제 픽셀로 변환한다. 이때 위치와 관계없는 CSS 속성 (색상, 투명도 등)을 적용한다.
7. composition
   - 각 레이어를 최종적으로 합성해 화면에 출력하는 과정이다.

<br/>

## Reflow, Repaint는 무엇인가?

### Reflow

레이아웃을 다시 계산하고 그리는 것을 말한다. 예를 들어, HTML 요소의 위치나 크기가 변경되었을 때 레이아웃을 다시 계산하고 다시 그려야 한다. 브라우저 성능에 영향을 미친다. 가능한 리플로우를 최소화 해야한다.

- 각 박스의 넓이는 viewport 기준
- 각 박스의 높이는 contents (font) 기준
- 따라서 윈도우 사이즈를 변경하거나 폰트를 변경하면 Global Layout 발생한다.
  - 따라서 윈도 사이즈 변경, 폰트 변경을 제외 하면 incremental layout이 발생한다.

### Repaint

요소가 변경 되었지만, 레이아웃이 변경되지 않은 경우 발생한다. 브라우저는 변경된 요소만 다시 그리는 것이 리페인트다. 성능에 덜 영향을 미치지만 여전히 성능에 영향을 미친다. 예시로, CSS 속성에 `background-color` 를 변경하는 것이 있다. 요소의 배경 색상을 변경하지만, 요소의 크기나 위치를 변경하지는 않는다. 따라서 브라우저는 변경된 요소만 다시 그리는 것이 리페인트다.

<br/>

## 강제로 Reflow가 발생하는 현상은 어떤 것이 있나?

- DOM 노드 추가, 제거
- DOM 위치 변경, 크기 변경
- 폰트 변경
- 텍스트 내용 변경
- 이미지 크기 변경
- 윈도우 리사이징
- 페이지 초기 렌더링이 일어났을 때

### Reflow를 최적화하려면? [링크](https://wit.nts-corp.com/2017/06/05/4571)

- 자바스크립트 실행에서 DOM 및 스타일 변경을 최소화 한다.
- 스타일을 변경할 경우 가장 하위 노드의 DOM을 조작하고 스타일을 변경해 영향 받는 요소가 적도록 한다.
- 애니메이션이 있는 노드는 position fixed / absolute로 지정해 노드를 전체 노드에서 분리시킨다. (statcking context를 생성해준다) -> repaint만 수행

### Repaint를 최적화하려면?

- 애니메이션 효과를 transform 속성을 이용하여, GPU 가속을 이용한 렌더링을 한다.
- display: none, visibility: hidden 속성을 사용하거나, 불필요한 요소를 제거하여 필요하지 않는 요소는 렌더링 되지 않도록한다.
- 이미지를 압축해서 용량을 최적화하거나, 아이콘을 사용하는 경우 스프라이트로 합쳐서 사용한다.
- requestAnimationFrame을 사용해 프레임 속도에 맞추어 애니메이션을 실행할 수 있도록 한다.

> ※ display: none, visibility: hidden의 차이 -> display: none은 아예 렌더트리에 포함되지 않는다.

<br/>

## Render Blocking Resource란?

HTML 문서가 로드될때 CSS 파일 또는 JS 파일을 만나게 되면 HTML을 렌더링 하지 않고 기다리게 되는데, 이때 CSS 파일과 JS 파일을 렌더 블로킹 리소스라고 한다. 

RBR를 최소화 하는 방법은, 가능한 모든 리소스를 미리 다운로드 하는 것이다. 브라우저 캐싱을 활용하고, HTML 문서의 head 태그 내부에 있는 리소스들의 크기를 최소화하여 처리 시간을 줄이는 것이 좋다. 또 script 태그에 async, defer를 사용해 비동기 방식으로 스크립트를 로드하거나, 필요한 자원만 로드하는 Lazy Loading 기법등을 활용해 불필요한 리소스 처리를 최소화할 수 있다.


