# 디바이스 해상도에 딱 맞는 이미지 제공하기

> [출처](https://blog.hoseung.me/2023-04-02-provide-fit-image)

웹에 접근할 수 있는 디바이스는 다양하다. 수많은 디바이스들에 어떤 이미지를 제공해야 하나?

큰 이미지를 화면이 작은 디바이스에 사용하기엔 유저 입장에서 불필요하게 큰 다운로드 비용이 생기는 것이고, 반대로 작은 이미지를 화면이 큰 디바이스에 사용하기엔 다운로드 비용은 적지만 화질이 떨어질 것이다.

디바이스 화면 크기에 맞춰 이미지를 제공하는게 가장 좋을 것이다. 그럼 이미지는 어떻게 준비하지? 이미지 하나가 추가될 때마다 모든 경우의 수를 고려해 이미지를 뽑아 업로드 해둬야 하나? 그러기엔 업무 비용, 저장소 비용이 아까움.

하나의 이미지를 준비해둔 후, 해당 디바이스의 화면 스펙에 따라 실시간으로 리사이징해 제공하는 것이 효율적이다. 또한 한 번 리사이징한 이미지를 오랜 시간 캐싱해둔다면, 비용을 더 아낄 수 있다.

- 올바른 이미지 제공을 위한 배경지식
  - 디스플레이 해상도와 픽셀 밀도
  - CSS 상의 픽셀과 물리적 픽셀의 차이
- 디바이스 해상도에 맞는 이미지를 제공하는 방법
  - `img` element의 `srcset`, `sizes` attribute
- 필요한 시점에 이미지를 동적으로 리사이징 하는 방법
  - AWS의 Lambda와 CloudeFront를 사용해 이미지 리사이징 서버 구성하기

<br/>

## 디스플레이 해상도와 픽셀 밀도

해상도는 대상이 몇 개의 픽셀로 이루어져 있는지 나타내는 값이다. `가로 픽셀 수 * 세로 픽셀 수` 형태로 표현된다. 화면 해상도가 높은 디바이스 일 수록 더 많은 것들을 화면에 그려낼 수 있다. 그렇다면 양이 아닌 질로 간다면 어떨까? 같은 것이라도 더 선명하고 정밀하게, 즉 좋은 화질로 그려내려면 무엇이 중요할까?

예를 들어, 해상도가 `400 * 400` 인 디바이스 A, `800 * 800` 인 디바이스 B가 있고, A와 B의 화면 크기는 같다고 가정해보자.

이때 `800 * 800` 해상도를 가진 이미지를 화면 전체에 그렸을 때, 더 화질이 좋은 디바이스는 무엇일까? 이미지의 해상도에 비해, A의 화면 해상도는 낮기 때문에 이미지를 온전히 표현할 수 없다. 하지만, B의 화면 해상도는 이미지와 동일하기 때문에, 이미지를 온전히 표현할 수 있다.

이렇게 같은 면적에 얼마나 많은 픽셀이 밀집되어 있는지를 픽셀 밀도라고 하고, 픽셀 밀도는 `PPI` 라는 단위로 표현한다. PPI는 Pixels Per Inch, 즉 1인치당 몇 픽셀을 표현할 수 있는지를 나타내는 단위다.

아래 사진을 보자. 더 높은 PPI를 가진 화면 위에서 그려진 오른쪽 원이 더 정밀하게 그려지는 것을 확인할 수 있다.

![image](https://github.com/pozafly/TIL/assets/59427983/1a2fd938-df39-4332-9c15-373c65614e25)

<br/>

## 디바이스의 픽셀과 CSS의 픽셀

아이폰 12는 `1170 * 2532`의 해상도와 460PPI의 매우 높은 픽셀 밀도를 가진다. 그런데 Chrome 브라우저에서 확인할 때, iPhone12의 해상도는 `390 * 844`로 실제 해상도 대비 매우 낮게 표현된다. 왜?

이유는, 모던 브라우저는 PPI가 높은 디바이스에 대해, CSS 1픽셀을 그리기 위해 디바이스의 물리적 픽셀 여러 개를 사용하기 때문이다. 그리고 그 물리적 픽셀이 몇 개인지를 Device Pixel Ratio, 줄여서 `DPR` 이라고 부른다.

아이폰 12의 DPR은 3으로, 아이폰 12에서 CSS 1픽셀을 그리기 위해서 물리적 픽셀 3개가 필요하다는 뜻이다. CSS 상의 해상도인 `390 * 844`에 DPR을 곱해보면 실제 해상도인 `1170 * 2532`가 나온다.

따라서 웹에서 이미지를 렌더링 할 때는, 이미지의 실제 크기에 DPR을 반영해줘야 한다. 아이폰 12를 예시로 들면, CSS 상에서 가로 100px로 이미지를 렌더링할 때, 실제로 사용되는 픽셀 수는 300이 되므로, 가로 300px의 해상도를 가진 이미지를 사용해야 화질이 저하되지 않는다.

여담으로 JavaScript에서는 [window.devicePixelRatio](https://developer.mozilla.org/ko/docs/Web/API/Window/devicePixelRatio)를 통해 DPR 값을 가져올 수 있다.

GitHub의 [custom-device-emulation-chrome](https://github.com/amirshnll/custom-device-emulation-chrome) 레포지토리에는 디바이스 별로 해상도와 DPR 정리가 잘 되어있어, 개발자 도구에서 모바일 디바이스를 새로 추가할 때 편리하다.

<br/>

## 디바이스 해상도에 맞는 이미지 제공하기

디바이스 해상도에 맞춰 올바른 크기의 이미지를 제공하는 방법을 알아보자.

`img` element에는 `sizes`와 `srcset` 이라는 attribute가 있다. 이 두 attribute를 잘 명시하여 브라우저가 올바른 이미지를 선택해 렌더링하도록 만들 수 있다.

`sizes`는 `img` element가 렌더링 될 CSS 상의 크기를 명시하는 attribute다. 이 때 크기를 여러 개 명시하여 조건에 따라 다르게 선택되도록 만들 수 있다.

`srcset`은 렌더링 될 이미지들을 명시하는 attribute다. 브라우저는 `sizes`나 DPR 값에 따라 명시된 이미지들 중 하나를 선택하여 렌더링 한다. (미리 이미지 사이즈 별로 종류별로 들고 있어야 함.)

### 이미지 크기에 맞춰 선택되게 하기 - srcset의 w descriptor와 sizes

`img` element가 렌더링 될 크기에 따라 올바른 이미지가 선택되도록 만드는 방법은, `srcset`에 이미지들을 명시할 때, `w` descriptor를 사용해, 명시한 이미지 각 크기를 브라우저에게 알려주는 것이다.

`w` descriptor로 이미지의 물리적 가로 픽셀 수를 명시하고, 명시한 이미지 각각은 콤마로 구분한다.

```html
<img srcset="300w.png 300w, 600w.png 600w, 900w.png 900w" />
```

위처럼 `sizes`가 명시되지 않은 경우, 브라우저는 `100vw`를 기준으로 이미지를 선택한다. 예를 들어, 100vw가 300px이고, DPR이 2인 디바이스에서는 아래와 같이 600w.png가 렌더링된다.

![image](https://github.com/pozafly/TIL/assets/59427983/34fb98f5-9ab2-4c80-8897-3638f8bee888)

디바이스의 `100vw`인 300px이 CSS 상의 픽셀이고, DPR이 2이므로, 렌더링에 가장 적합한 600w.png가 선택된 것이다.

그럼 `sizes`를 명시한다면?

```html
<img srcset="300w.png 300w, 600w.png 600w, 900w.png 900w" sizes="350px" />
```

이 경우 `sizes`가 `350px`로 고정되어 있으므로, 디바이스의 viewport width가 아닌 DPR에 따라 이미지가 정해진다.

똑같이 DPR이 2인 디바이스라고 가정하면 똑같이 600w.png가 선택된다.

이때 DPR이 2인 상황에서 CSS 350px을 화질 저하 없이 렌더링하기 위해서는 물리적 700 픽셀이 필요하다.

그럼에도 물리적 100px이 부족한 `600`이 선택된 것을 보면, 브라우저가 이미지 선택에 고려하는 것이 화질 말고도 훨씬 많다는 점을 알 수 있다. 이는 사용자의 설정, 디바이스의 네트워크 대역폭 등 브라우저 구현에 따라 천차만별이다.

위 예시의 경우 `900w.png`를 불러왔을 때 생기는 상황을 고려했을 때, `600w.png`를 사용했을 때 생기는 물리적 100px 만큼의 화질 손실은 감수할 만하다는 결정을 내린 것이다.

`sizes`를 명시할 때는 CSS의 Media Queury를 활용, 브라우저가 조건에 따라 크기를 선택하도록 할 수 있다. `srcset`에 이미지들을 나열할 때처럼 콤마로 구분해 나열한다.

```html
<img
  srcset="300w.png 300w, 600w.png 600w, 900w.png 900w"
  sizes="(max-width: 700px) 300px, (max-width: 1000px) 600px, 900px"
/>
```

이번엔 예시를 조금 바꿔, 디바이스의 DPR을 1이라 가정해보자.

만약 디바이스의 viewport width가 500px인 경우, `(max-width: 700px)`에 걸리기 때문에, 선택되는 사이즈는 300px이다. 따라서 아래와 같이 300w.png가 렌더링된다.

![image](https://github.com/pozafly/TIL/assets/59427983/32bad5f9-ce88-4ef9-8643-b299cca1beec)

그리고 디바이스의 viewport width가 800px, 1200px인 경우, 각각 600px, 900px 의 사이즈가 선택된다.

### srcset의 브라우저 호환성 챙기기

`srcset`의 [브라우저 호환성에 대해 확인](https://caniuse.com/?search=srcset)해보면 지원 현황이 매우 좋다. 하지만 여전히 srcset이 지원되지 않는 브라우저를 위해 `src`는 꼭 추가해주자.

```html
<img
  srcset="300w.png 1x, 600w.png 2x, 900w.png 3x"
  width="300px"
  sizes="(max-width: 700px) 300px, (max-width: 1000px) 600px, 900px"
  src="300w.png"
  alt=""
/>
```

