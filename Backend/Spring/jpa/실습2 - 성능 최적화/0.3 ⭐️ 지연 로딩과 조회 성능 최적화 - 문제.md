# â­ï¸ ì§€ì—° ë¡œë”©ê³¼ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™” - ë¬¸ì œ

## ì§€ì—°ë¡œë”©

ì•„ì£¼ ì¤‘ìš”! ì§€ì—° ë¡œë”© ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œ.

ë¨¼ì € ì‹¬í”Œí•˜ê²Œ ë§Œë“¤ì–´ë³´ì. OrderëŠ” Entityê³ , Entity ë…¸ì¶œí•˜ë©´ ì•ˆë˜ëŠ”ë° í•œë²ˆ ì¼ë‹¨ í•´ë³¸ë‹¤.
ğŸ“Œ ì•„ë˜ëŠ” ì½”ë“œë¥¼ ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  í•„ìš”ëŠ” ì—†ìŒ. Entityë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°”ë¡œ ë…¸ì¶œì‹œí‚¤ì§„ ì•Šì„ ê²ƒì´ê¸° ë•Œë¬¸.

```java
public class Order {  
  
    //...
  
    @ManyToOne(fetch = FetchType.LAZY)  
    @JoinColumn(name = "member_id")  
    private Member member;  
  
    @OneToOne(fetch = FetchType.LAZY, cascade = CascadeType.ALL)  
    @JoinColumn(name = "delivery_id")  
    private Delivery delivery;
}
```

```java
@GetMapping("/api/v1/simple-orders")  
public List<Order> simpleOrders() {  
    List<Order> all = orderRepository.findByString(new OrderSearch());  
    return all;  
}
```

<img width="617" alt="Image" src="https://github.com/user-attachments/assets/5910613c-da29-40ae-91c6-0b0b173653f9" />
ì´ë ‡ê²Œ ëŠì„ ì—†ì´ ë°ì´í„°ê°€ ë‚˜ì˜¤ê²Œ ëœë‹¤. ë¬´í•œë£¨í”„ì„.
Order ì•ˆì— Memberê°€ ìˆë‹¤.

```java
// Member.java
@OneToMany(mappedBy = "member")  
private List<Order> orders = new ArrayList<>();
```

member ì•ˆì— ordersê°€ ìˆë‹¤. ì„œë¡œê°€ ì„œë¡œë¥¼ ì°¸ì¡°í•˜ê¸° ë•Œë¬¸ì— ë¬´í•œë£¨í”„ì„.

ë”°ë¼ì„œ ë‘˜ ì¤‘ í•˜ë‚˜ëŠ” `@JsonIgnore` ì–´ë…¸í…Œì´ì…˜ ë¶™ì—¬ì£¼ì–´ì•¼ í•œë‹¤.

```java
// Member.java
@JsonIgnore
@OneToMany(mappedBy = "member")  
private List<Order> orders = new ArrayList<>();
```

ê·¸ë¦¬ê³  Deliveryë„ @OneToOne ì´ë¯€ë¡œ Delivery ìª½ì—ë„ @JsonIgnore ë¶™ì—¬ì£¼ì.
ê·¸ëŸ¬ë©´ ë‹¤ë¥¸ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

```json
"status": 500,
"error": "Internal Server Error",
"trace": "org.springframework.http.converter.HttpMessageConversionException: Type definition error: [simple type, class org.hibernate.proxy.pojo.bytebuddy.ByteBuddyInterceptor]
```

bytebuddyë€, í”„ë¡ì‹œ ê°ì²´ë‹¤. `Member` lazy loadingì´ ê±¸ë ¤ìˆê³  nullì¼ ìˆ˜ëŠ” ì—†ìœ¼ë‹ˆ ë‚´ë¶€ì ìœ¼ë¡œ

```java
// Order.java

@ManyToOne(fetch = LAZY)
private Member member = new Bytebutty();
```

ì´ëŸ°ì‹ìœ¼ë¡œ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•œë‹¤. ê·¸ëŸ°ë° ByteBuddyê°€ Member ê°ì²´ëŠ” ì§€ì—°ë¡œë”©ì´ë¯€ë¡œ ì •ë³´ê°€ ì—†ê¸° ë•Œë¬¸ì— Jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì˜¤ë¥˜ë¥¼ ë±‰ëŠ” ê²ƒì„.

- `order` -> `member` ì™€ `order` -> `delivery` ëŠ” ì§€ì—° ë¡œë”©ì´ë‹¤. ë”°ë¼ì„œ ì‹¤ì œ ì—”í‹°í‹° ëŒ€ì‹  í”„ë¡ì‹œ ì¡´ì¬
- jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì´ í”„ë¡ì‹œ ê°ì²´ë¥¼ jsonìœ¼ë¡œ ì–´ë–»ê²Œ ìƒì„±í•´ì•¼ í•˜ëŠ”ì§€ ëª¨ë¦„ -> ì˜ˆì™¸ ë°œìƒ
- `Hibernate5Module` ì„ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡í•˜ë©´ í•´ê²°

``implementation 'com.fasterxml.jackson.datatype:jackson-datatype-hibernate5jakarta'``
ì„ dependenciesì— ë„£ì–´ì£¼ì.

```java {8-11}
@SpringBootApplication  
public class JpashopApplication {  
  
    public static void main(String[] args) {  
        SpringApplication.run(JpashopApplication.class, args);  
    }  
  
    @Bean  
	Hibernate5JakartaModule hibernate5Module() {  
	    return new Hibernate5JakartaModule();  
	}
}
```

- ê¸°ë³¸ì ìœ¼ë¡œ ì´ˆê¸°í™” ëœ í”„ë¡ì‹œ ê°ì²´ë§Œ ë…¸ì¶œ, ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ í”„ë¡ì‹œ ê°ì²´ëŠ” ë…¸ì¶œ ì•ˆí•¨

ê²°ê³¼ëŠ”

```json
[
    {
        "id": 1,
        "member": null,
        "orderItems": null,
        "delivery": null,
        "orderDate": "2025-05-04T00:18:10.90912",
        "status": "ORDER",
        "totalPrice": 30000
    },
    {
        "id": 2,
        "member": null,
        "orderItems": null,
        "delivery": null,
        "orderDate": "2025-05-04T00:18:10.936909",
        "status": "ORDER",
        "totalPrice": 220000
    }
]
```

ì´ëŸ° ì‹ìœ¼ë¡œ ì˜ ë‚˜ì˜¨ë‹¤.
ë‹¨, `member`, `orderItems`, `delivery` ëŠ” ì§€ì—° ë¡œë”©ì´ë¯€ë¡œ nullë¡œ ë–¨ì–´ì§„ë‹¤.

```java
@Bean  
Hibernate5JakartaModule hibernate5Module() {  
    Hibernate5JakartaModule hibernate5JakartaModule = new Hibernate5JakartaModule();  
    // ê°•ì œ ì§€ì—° ë¡œë”© ì„¤ì •  
    hibernate5JakartaModule.configure(Hibernate5JakartaModule.Feature.FORCE_LAZY_LOADING, true);  
    return hibernate5JakartaModule;  
}
```

ì´ ì˜µì…˜ì„ í‚¤ë©´ `order -> member`, `member -> orders` ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ê³„ì† ë¡œë”©í•˜ê²Œ ëœë‹¤. ë”°ë¼ì„œ `@JsonIgnore` ì˜µì…˜ì„ í•œ ê³³ì— ì£¼ì–´ì•¼ í•¨.

```json
[
    {
        "id": 1,
        "member": {
            "id": 1,
            "name": "userA",
            "address": {
                "city": "ì„œìš¸",
                "street": "1",
                "zipcode": "1111"
            }
        },
        "orderItems": [
            {
                "id": 1,
                "item": {
                    "id": 1,
                    "name": "JPA1 BOOK",
                    "price": 10000,
                    "stockQuantity": 99,
                    "categories": [],
                    "author": null,
                    "isbn": null
                },
                "orderPrice": 10000,
                "count": 1,
                "totalPrice": 10000
            },
            {
                "id": 2,
                "item": {
                    "id": 2,
                    "name": "JPA2 BOOK",
                    "price": 20000,
                    "stockQuantity": 99,
                    "categories": [],
                    "author": null,
                    "isbn": null
                },
                "orderPrice": 20000,
                "count": 1,
                "totalPrice": 20000
            }
        ],
        "delivery": {
            "id": 1,
            "address": {
                "city": "ì„œìš¸",
                "street": "1",
                "zipcode": "1111"
            },
            "status": null
        },
        "orderDate": "2025-05-04T00:24:07.957475",
        "status": "ORDER",
        "totalPrice": 30000
    },
    // ...
]
```

ì´ë ‡ê²Œ ì „ë¶€ ë…¸ì¶œì´ ë˜ì–´ë²„ë¦°ë‹¤. Orderë§Œ í•„ìš”í•œ ì •ë³´ì˜€ëŠ”ë°, ë‹¤ë¥¸ ì •ë³´ê¹Œì§€ ëª¨ë‘ ë…¸ì¶œë˜ê³  ì„±ëŠ¥ ë¬¸ì œë„ ìƒê¸°ê²Œ ëœë‹¤.

ê·¸ëŸ¼ memberë§Œ lazyë¡œ ê°€ì ¸ì˜¤ê³  ì‹¶ì„ ê²½ìš° ì–´ë–»ê²Œ í•´ì•¼í•˜ë‚˜?
ë¨¼ì € hibernate ê°•ì œ ì§€ì—° ë¡œë”©ì„ ì œê±°,

```java
// ê°•ì œ ì§€ì—° ë¡œë”© ì„¤ì •  
// hibernate5JakartaModule.configure(Hibernate5JakartaModule.Feature.FORCE_LAZY_LOADING, true);
```

ê·¸ë¦¬ê³  orderì•ˆì— ìˆëŠ” memberê°ì²´ë¥¼ êº¼ë‚´ë©´ ëœë‹¤.

```java {4-6}
@GetMapping("/api/v1/simple-orders")  
public List<Order> simpleOrders() {  
    List<Order> all = orderRepository.findByString(new OrderSearch());  
    for (Order order : all) {  
        order.getMember().getName();  // Lazy ê°•ì œ ì´ˆê¸°í™”
    }  
    return all;  
}
```

`order.getMember()` ëŠ” í”„ë¡ì‹œ ê°ì²´ë‹¤. `.getName()` ì„ í•˜ë©´ DBì—ì„œ ì¡°íšŒí•´ ê°€ì§€ê³  ì˜¨ë‹¤.

```json
[
    {
        "id": 1,
        "member": {
            "id": 1,
            "name": "userA",
            "address": {
                "city": "ì„œìš¸",
                "street": "1",
                "zipcode": "1111"
            }
        },
        "orderItems": null,
        "delivery": null,
        "orderDate": "2025-05-04T14:16:41.255441",
        "status": "ORDER",
        "totalPrice": 30000
    },
    // â€¦
}
```

> ì£¼ì˜: ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0 ì´ìƒì´ë©´ `Hibernate5Module` ëŒ€ì‹ ì— `Hibernate5JakartaModule` ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

> ì£¼ì˜: ì—”í‹°í‹°ë¥¼ ì§ì ‘ ë…¸ì¶œí•  ë•ŒëŠ” ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ê°€ ê±¸ë¦° ê³³ì€ ê¼­! í•œê³³ì„ `@JsonIgnore` ì²˜ë¦¬ í•´ì•¼ í•œë‹¤. ì•ˆê·¸ëŸ¬ë©´ ì–‘ìª½ì„ ì„œë¡œ í˜¸ì¶œí•˜ë©´ì„œ ë¬´í•œ ë£¨í”„ê°€ ê±¸ë¦°ë‹¤.

> ì°¸ê³ : ì•ì—ì„œ ê³„ì† ê°•ì¡°í–ˆë“¯ì´ ì •ë§ ê°„ë‹¨í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ë‹ˆë©´ ì—”í‹°í‹°ë¥¼ API ì‘ë‹µìœ¼ë¡œ ì™¸ë¶€ë¡œ ë…¸ì¶œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤. ë”°ë¼ì„œ `Hibernate5Module` ë¥¼ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” DTOë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜í•˜ëŠ” ê²ƒì´ ë” ì¢‹ì€ ë°©ë²•ì´ë‹¤.

> ì£¼ì˜: ì§€ì—° ë¡œë”©(LAZY)ì„ í”¼í•˜ê¸° ìœ„í•´ ì¦‰ì‹œ ë¡œë”©(`EARGR`)ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì•ˆëœë‹¤! ì¦‰ì‹œ ë¡œë”© ë•Œë¬¸ì— ì—°ê´€ê´€ê³„ê°€ í•„ìš” ì—†ëŠ” ê²½ìš°ì—ë„ ë°ì´í„°ë¥¼ í•­ìƒ ì¡°íšŒí•´ì„œ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì„±ëŠ¥ íŠœë‹ì´ ë§¤ ìš° ì–´ë ¤ì›Œ ì§„ë‹¤. í•­ìƒ ì§€ì—° ë¡œë”©ì„ ê¸°ë³¸ìœ¼ë¡œ í•˜ê³ , ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš°ì—ëŠ” í˜ì¹˜ ì¡°ì¸(fetch join)ì„ ì‚¬ìš©í•´ë¼!(V3ì—ì„œ ì„¤ëª…)

## ì—”í‹°í‹°ë¥¼ DTOë¡œ ë³€í™˜

```java
@GetMapping("/api/v2/simple-orders")  
public List<SimpleOrderDto> ordersV2() {  
    List<Order> orders = orderRepository.findByString(new OrderSearch());  
    List<SimpleOrderDto> result = orders.stream()  
            .map(o -> new SimpleOrderDto(o))  
            .collect(Collectors.toList());  
    return result;  
}  
  
@Data  
static class SimpleOrderDto {  
    private Long orderId;  
    private String name;  
    private LocalDateTime orderDate;  
    private OrderStatus orderStatus;  
    private Address address;  
  
    public SimpleOrderDto(Order order) {  
        orderId = order.getId();  
        orderDate = order.getOrderDate();  
        name = order.getMember().getName();  
        orderStatus = order.getStatus();  
        address = order.getDelivery().getAddress();  
    }  
}
```

API responseì— ìµœì í™” ëœ ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤.

## v1, v2ë¬¸ì œì 

ë ˆì´ì§€ë¡œë”©ìœ¼ë¡œ ì¸í•œ SQLì´ ë„ˆë¬´ ë§ì´ ì‹¤í–‰ëœë‹¤.
ì¿¼ë¦¬ê°€ ì´ 1 + N + Në²ˆ ì‹¤í–‰ëœë‹¤. (v1ê³¼ ì¿¼ë¦¬ìˆ˜ ê²°ê³¼ëŠ” ê°™ë‹¤.)
- `order` ì¡°íšŒ 1ë²ˆ (order ì¡°íšŒ ê²°ê³¼ ìˆ˜ê°€ Në²ˆ)
- `order` -> `member` ì§€ì—° ë¡œë”© ì¡°íšŒ Në²ˆ
- `order` -> `delivery` ì§€ì—° ë¡œë”© ì¡°íšŒ Në²ˆ
- ì˜ˆ) orderì˜ ê²°ê³¼ê°€ 4ê°œë©´ ìµœì•…ì˜ ê²½ìš° 1 + 4 + 4ë²ˆ ì‹¤í–‰ëœë‹¤.
	- ì§€ì—° ë¡œë”©ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì¡°íšŒí•˜ë¯€ë¡œ, ì´ë¯¸ ì¡°íšŒëœ ê²½ìš° ì¿¼ë¦¬ë¥¼ ìƒëµí•œë‹¤.
