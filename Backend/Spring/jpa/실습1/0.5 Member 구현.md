# Member êµ¬í˜„

## Repository

```java
@Repository  
public class MemberRepository {  
  
    @PersistenceContext  
    private EntityManager em;  
  
    public void save(Member member) {  
        em.persist(member);  
    }  
  
    public Member findOne(Long id) {  
        return em.find(Member.class, id);  
    }  
  
    public List<Member> findAll() {  
        return em.createQuery("select m from Member m", Member.class)  
                .getResultList();  
    }  
  
    public List<Member> findByName(String name) {  
        return em.createQuery("select m from Member m where m.name = :name", Member.class)  
                .setParameter("name", name)  
                .getResultList();  
    }  
}
```

interfaceë¥¼ ì•„ì§ ì“°ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ, ë‹¨ê±´ ì¡°íšŒë¥¼ ì œì™¸í•œ ê²ƒì€ JPQL ì‚¬ìš©í•´ì•¼ í•¨.

## Service

```java
@Service  
@Transactional(readOnly = true)  
public class MemberService {  
  
    @Autowired  
    private MemberRepository memberRepository;  
  
    /**  
     * íšŒì› ê°€ì…  
     */  
    @Transactional  
    public Long join(Member member) {  
        validateDuplicateMember(member);  // ì¤‘ë³µ íšŒì› ê²€ì¦  
        memberRepository.save(member);  
        return member.getId();  
    }  
  
    private void validateDuplicateMember(Member member) {  
        List<Member> findMembers = memberRepository.findByName(member.getName());  
        if (!findMembers.isEmpty()) {  
            throw new IllegalStateException("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íšŒì›ì…ë‹ˆë‹¤.");  
        }  
    }  
  
    // íšŒì› ì „ì²´ ì¡°íšŒ  
    public List<Member> findAll() {  
        return memberRepository.findAll();  
    }  
  
    public Member findById(Long id) {  
        return memberRepository.findOne(id);  
    }  
}
```

### ê²€ì¦(validateDuplicateMember)

> ğŸ“Œ ì‹¤ë¬´ì—ì„œëŠ” ê²€ì¦ ë¡œì§ì´ ìˆì–´ë„ ë©€í‹° ì“°ë ˆë“œ ìƒí™©ì„ ê³ ë ¤í•´ì„œ íšŒì› í…Œì´ë¸”ì˜ íšŒì›ëª… ì»¬ëŸ¼ì— ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤.

### @Transactional

`@Transactional` ì€, í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì´ë£¨ì–´ì ¸ì•¼ í•˜ë¯€ë¡œ `join` ì—ëŠ” ë¶™ì–´ì•¼ í•œë‹¤.
í•˜ì§€ë§Œ, íšŒì› í•˜ë‚˜ì™€ íšŒì› ì „ì²´ ì¡°íšŒëŠ” `@Transactional(readOnly = true)` ì•ˆì—ì„œ ì´ë£¨ì–´ì§€ë©´ ìµœì í™”ê°€ ì´ë£¨ì–´ì§„ë‹¤.
ë”°ë¼ì„œ, class ìœ„ì— ë¶™ì—¬ì£¼ê³ , `join` ê°™ì€ ê²½ìš° readOnlyê°€ ë¶™ìœ¼ë©´ ì•ˆë˜ë¯€ë¡œ ë”°ë¡œ ë„£ì–´ì¤Œ.

### @Autowired

### Field Injection

```java
@Autowired  
private MemberRepository memberRepository;
```

ì´ ë¶€ë¶„ì€ í…ŒìŠ¤íŠ¸í•˜ê¸° ê¹Œë‹¤ë¡­ë‹¤. mock data ì£¼ì…ì´ ì•ˆëœë‹¤. ê·¸ë˜ì„œ setter injectionë¥¼ ì“°ê¸°ë„ í•¨

### Setter Injection

```java
private MemberRepository memberRepository;

@Autowired
public void setMemberRepository(MemberRepository memberRepository) {
	this.memberRepository = memberRepository;
}
```

í•˜ì§€ë§Œ, ì´ë ‡ê²Œ í•  ê²½ìš°, ë‹¤ë¥¸ ê°œë°œìê°€ ì € ë©”ì„œë“œ ì•ˆì— ë‹¤ë¥¸ ë¡œì§ì„ ë„£ì„ ê²½ìš°ë„ ìƒê¸´ë‹¤.

```java
public static void main(String[] args) {
	MemberService service = new MemberService();

	// ì´ˆê¸° ì£¼ì…
	service.setMemberRepository(new NormalMemberRepository());
	// ì •ìƒì ìœ¼ë¡œ ë™ì‘
	System.out.println(service.findMemberName(1L));

	// ğŸ’£ ì–´ë”˜ê°€ì—ì„œ ì˜ë„ì ìœ¼ë¡œ í˜¹ì€ ì‹¤ìˆ˜ë¡œ ì˜ì¡´ì„± ë°”ê¿”ì¹˜ê¸°
	service.setMemberRepository(new FakeOrBrokenMemberRepository());
	// ì´ì œ serviceëŠ” ê°€ì§œ repositoryë¥¼ ì“°ê²Œ ë¨
	System.out.println(service.findMemberName(1L)); // ì˜ëª»ëœ ë™ì‘ ë°œìƒ ê°€ëŠ¥
}
```

ê·¸ë¦¬ê³ , ìŠ¤í”„ë§ë¶€íŠ¸ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰í•  ë•Œ ì´ë¯¸ Bean ìƒì„± ë° DI ì£¼ì…ì´ ë‹¤ ëë‚˜ë²„ë¦¬ê¸° ë•Œë¬¸ì— **ëŸ°íƒ€ì„**ì— ì €ê±¸ ê±´ë“œë¦´ ì¼ì€ ì‚¬ì‹¤ìƒ ì—†ë‹¤. ê·¸ëŸ¬ë©´ ì € Setter Injectionì´ ì¢‹ì§€ ì•ŠìŒ.

### Constructor Injection

ê·¸ëŸ¼ ìƒì„±ì Injectionì„ ì‚¬ìš©í•˜ëŠ”ê²Œ ì¢‹ë‹¤.

```java
private MemberRepository memberRepository;  
  
@Autowired  
public MemberService(MemberRepository memberRepository) {  
    this.memberRepository = memberRepository;  
}
```

ì´ëŸ¬ë©´ í…ŒìŠ¤íŠ¸ í•˜ê¸°ë„ ì¢‹ê³ , ëŸ°íƒ€ì„ ì‹œì ì— ë‹¤ë¥¸ ì–´ë–¤ ê°ì²´ê°€ ë“¤ì–´ì˜¬ ìˆ˜ë„ ì—†ìŒ.
ê·¼ë° ì½”ë“œê°€ ê¸¸ì–´ì¡ŒìŒ. ìŠ¤í”„ë§ 4.3 ë¶€í„°ëŠ” `@Autowired`ê°€ ì—†ì–´ë„ ìƒì„±ìê°€ í•˜ë‚˜ë¼ë©´ ìë™ìœ¼ë¡œ ë„£ì–´ì¤€ë‹¤.

```java
private final MemberRepository memberRepository;  
  
public MemberService(MemberRepository memberRepository) {  
    this.memberRepository = memberRepository;  
}
```

ê·¸ë¦¬ê³  ì € í•„ë“œëŠ” ë³€ê²½ë  ì¼ì´ ì—†ê¸° ë•Œë¬¸ì— `final` ë¡œ ì„ ì–¸í•´ì£¼ëŠ”ê²Œ ì¢‹ë‹¤.

### ë¡¬ë³µ Injection

```java {1}
@AllArgsConstructor  
public class MemberService {  
  
    private final MemberRepository memberRepository;  
  
    // @Autowired  
    // public MemberService(MemberRepository memberRepository) {         //     this.memberRepository = memberRepository;    
    // }
```

`@AllArgsConstructor` ì–´ë…¸í…Œì´ì…˜ì€ @Autowired ì£¼ì„ì²˜ë¦¬ëœ ë¶€ë¶„ì„ ìë™ìœ¼ë¡œ ë„£ì–´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì„. ê·¸ëŸ¼ ì €ê²ƒë§Œ ë¶™ì—¬ë„ ë˜ê² ì§€?

`@RequiredArgsConstructor` ë„ ìˆìŒ. finalì´ ë¶™ì€ í•„ë“œì— ìë™ìœ¼ë¡œ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜.

```java {1}
@RequiredArgsConstructor  
public class MemberService {  
  
    private final MemberRepository memberRepository;
    // ...
}
```

ì´ë ‡ê²Œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

## TEST

### ê¸°ìˆ  ì„¤ëª…

- `@RunWith(SpringRunner.class)`: ìŠ¤í”„ë§ê³¼ í…ŒìŠ¤íŠ¸ í†µí•©
- `@SpringBootTest`: ìŠ¤í”„ë§ ë¶€íŠ¸ ë„ìš°ê³  í…ŒìŠ¤íŠ¸(ì´ê²Œ ì—†ìœ¼ë©´ `@Autowired` ë‹¤ ì‹¤íŒ¨)
- `@Transactional`: ë°˜ë³µ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ ì§€ì›, ê°ê°ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  **í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ íŠ¸ëœì­ì…˜ì„ ê°•ì œë¡œ ë¡¤ë°± (ì´ ì–´ë…¸í…Œì´ì…˜ì´ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ì—ì„œ ì‚¬ìš©ë  ë•Œë§Œ ë¡¤ë°±)**

### íšŒì›ê°€ì…

```java
@RunWith(SpringRunner.class)  
@SpringBootTest  
@Transactional  // ì´ê²Œ ë¶™ì–´ì•¼ ë¡¤ë°±í•´ì¤Œ
public class MemberServiceTest {  
  
    @Autowired  // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•˜ë‹ˆ @Autowired ì¨ë„ ë¬´ë°©
    MemberService memberService;  
    @Autowired  
    MemberRepository memberRepository;  
  
    @Test  
    @DisplayName("íšŒì›ê°€ì…")  
    public void íšŒì›ê°€ì…() {  
        // given  
        Member member = new Member();  
        member.setName("kim");  
  
        // when  
        Long savedId = memberService.join(member);  
  
        // then  
        Assert.assertEquals(member, memberRepository.findOne(savedId));  
  
    }
}
```

ëŒë ¤ë³´ë©´ ì‹ ê¸°í•˜ê²Œ `insert` ì¿¼ë¦¬ê°€ ë‚˜ê°€ì§€ ì•ŠìŒ.
ì™œëƒë©´ `join` ë©”ì„œë“œë¥¼ íƒ€ê³  ë“¤ì–´ê°€ë³´ë©´, `em.persist(member)` ì´ê¸° ë•Œë¬¸. insert ì¿¼ë¦¬ ì•ˆë‚˜ê°„ë‹¤.
`em.flush()` ë˜ì–´ì•¼ insert ëœë‹¤.

ê·¸ë˜ë„ ëˆˆìœ¼ë¡œ ë³´ê³  ì‹¶ìœ¼ë©´

```java {3}
	@Test  
    @DisplayName("íšŒì›ê°€ì…")  
    @Rollback(false)
    public void íšŒì›ê°€ì…() {
```

@Rollback(false) ë¥¼ ì£¼ë©´ insert ë¬¸ì„ ë³¼ ìˆ˜ìˆìŒ.

```sql
insert into member (city,street,zipcode,name,member_id) values (NULL,NULL,NULL,'kim');
```

ë˜ Rollbackì„ ì‚´ë¦¬ë©´ì„œ insert ì¿¼ë¦¬ë¬¸ë„ ë³´ê³  ì‹¶ë‹¤ë©´,

```java {1,12}
@Autowired EntityManager em;  
  
@Test  
@DisplayName("íšŒì›ê°€ì…")  
public void íšŒì›ê°€ì…() {  
    // given  
    Member member = new Member();  
    member.setName("kim");  
  
    // when  
    Long savedId = memberService.join(member);  
    em.flush();  
    // then  
    Assert.assertEquals(member, memberRepository.findOne(savedId));  
  
}
```

@Rollback(false) ì‚¬ìš©í•˜ì§€ ì•Šê³ , entityManagerë¥¼ ì§ì ‘ ë¶ˆëŸ¬ flush() ë©”ì„œë“œ í˜¸ì¶œí•´ì£¼ë©´ `insert` ë¬¸ë„ ë³´ê³ , rollbackë„ ëœë‹¤.

### ì¤‘ë³µíšŒì›

```java
@Test  
@DisplayName("ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸")  
public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() {  
    // given  
    Member member1 = new Member();  
    member1.setName("kim");  
  
    Member member2 = new Member();  
    member2.setName("kim");  
  
    // when  
    memberService.join(member1);  
    try {  
        memberService.join(member2); // ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•¨!  
    } catch (IllegalStateException e) {  
        return;  
    }  
  
    // then  
    Assert.fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");  
}
```

2ë²ˆ ê°™ì€ ì´ë¦„ìœ¼ë¡œ joiní•˜ë©´ í„°ì§. `try catch` ì‚¬ìš©í•œë‹¤.
í•˜ì§€ë§Œ ì†ŒìŠ¤ê°€ ë”ëŸ¬ìš°ë‹ˆ

```java {1}
@Test(expected = IllegalStateException.class)  
@DisplayName("ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸")  
public void ì¤‘ë³µ_íšŒì›_ì˜ˆì™¸() {  
    // given  
    Member member1 = new Member();  
    member1.setName("kim");  
  
    Member member2 = new Member();  
    member2.setName("kim");  
  
    // when  
    memberService.join(member1);  
    memberService.join(member2); // ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•¨!  
  
    // then    Assert.fail("ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.");  
}
```

## í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìœ„í•œ ì„¤ì •

[[application.yml ì„¤ì •#í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ìœ„í•œ ì„¤ì •]]
