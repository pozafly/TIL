# ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

## ê°œìš”

JPAëŠ” updateë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ ë”í‹° ì²´í‚¹ í›„ update í•œë‹¤.
ì¦‰, select ì´í›„ì— ê°€ì ¸ì˜¨ Entityë¥¼ setXXX í•´ì£¼ë©´ ìžë™ìœ¼ë¡œ update í•´ì£¼ëŠ” ë°©ì‹.
í•˜ì§€ë§Œ, ì—¬ëŸ¬ rowë¥¼ í•œë²ˆì— ì—…ë°ì´íŠ¸ í•´ì£¼ì–´ì•¼ í•  ê²½ìš°, rowë¥¼ ì¼ì¼ì´ ì¡°íšŒ í•œ ë‹¤ìŒ í•˜ë‚˜ì”© update í•œë‹¤ë©´ ë§Žì€ ì–‘ì˜ ì¿¼ë¦¬ë¬¸ì´ ì‚¬ìš©ëœë‹¤.
ì´ ë•Œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì¿¼ë¦¬ í•œ ë²ˆì— ë§Žì€ rowë¥¼ ì—…ëŽƒí•  ìˆ˜ ìžˆê¸° ë•Œë¬¸ì— ì‚¬ìš©í•¨.

## ì‚¬ìš© ë°©ë²•

### JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

```java
public int bulkAgePlus(int age) {
	int resultCount = em.createQuery(
	"update Member m set m.age = m.age + 1" + "where m.age >= :age")
			.setParameter("age", age)
			.executeUpdate();
	return resultCount;
}
```

### JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸

```java
@Test
public void bulkUpdate() throws Exception {
	//given
	memberJpaRepository.save(new Member("member1", 10));
	memberJpaRepository.save(new Member("member2", 19));
	memberJpaRepository.save(new Member("member3", 20));
	memberJpaRepository.save(new Member("member4", 21));
	memberJpaRepository.save(new Member("member5", 40));
	
	//when
	int resultCount = memberJpaRepository.bulkAgePlus(20);
	
	//then
	assertThat(resultCount).isEqualTo(3);
}
```

### ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•œ ë²Œí¬ì„± ìˆ˜ì • ì¿¼ë¦¬

```java
@Modifying
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")
int bulkAgePlus(@Param("age") int age);
```

- ë²Œí¬ì„± ìˆ˜ì •, ì‚­ì œ ì¿¼ë¦¬ëŠ” `@Modifying` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©
	- ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ ì˜ˆì™¸ ë°œìƒ
	- `org.hibernate.hql.internal.QueryExecutionRequestException: Not supported for DML operations`
- ë²Œí¬ì„± ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ê³  ë‚˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”: `@Modifying(clearAutomatically = true)`
	- (ì´ ì˜µì…˜ì˜ ê¸°ë³¸ê°’ì€ `false`)
	- ì´ ì˜µì…˜ ì—†ì´ íšŒì›ì„ `findById` ë¡œ ë‹¤ì‹œ ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ê³¼ê±° ê°’ì´ ë‚¨ì•„ì„œ ë¬¸ì œê°€ ë  ìˆ˜ ìžˆë‹¤. ë§Œì•½ ë‹¤ì‹œ ì¡°íšŒí•´ì•¼ í•˜ë©´ ê¼­ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•˜ìž.

> ðŸ“Œ ì°¸ê³ : ë²Œí¬ ì—°ì‚°ì€ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¬´ì‹œí•˜ê³  ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì—, ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ìžˆëŠ” ì—”í‹°í‹°ì˜ ìƒíƒœì™€ DBì— ì—”í‹°í‹° ìƒíƒœê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìžˆë‹¤.

```java {12}
public void bulkUpdate() {  
    // given  
    memberRepository.save(new Member("member1", 10));  
    memberRepository.save(new Member("member2", 19));  
    memberRepository.save(new Member("member3", 20));  
    memberRepository.save(new Member("member4", 21));  
    memberRepository.save(new Member("member5", 40));  
  
    // when  
    int resultCount = memberRepository.bulkAgePlus(20);  
  
    Member findMember = memberRepository.findByUsername("member5").get(0);  
    System.out.println("findMember = " + findMember);  
    // findMember = Member(id=5, username=member5, age=40)
  
    // then  
    assertThat(resultCount).isEqualTo(3);  
}
```

bulkAgePlusë¥¼ ì‹¤í–‰í•´ì„œ 20ì‚´ ì´í›„ëŠ” 1ì‚´ ë” update í•¨. ê·¸ëŸ¼, `findByUsername` ìœ¼ë¡œ ì°¾ì€ ê°ì²´ì˜ ë‚˜ì´ëŠ” ëª‡ì‚´ì¼ê¹Œ?
41ìœ¼ë¡œ ìƒê°í•˜ê¸° ì‰½ì§€ë§Œ, `40` ìž„.
ì™œëƒí•˜ë©´ ë²Œí¬ ì—…ë°ì´íŠ¸ëŠ” DBì— ì´ë¯¸ ë°˜ì˜ë˜ì—ˆì§€ë§Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ëŠ” ë°˜ì˜ì´ ì•ˆë˜ì—ˆê¸° ë•Œë¬¸ìž„.

**ê¶Œìž¥í•˜ëŠ” ë°©ì•ˆ**
1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ì—†ëŠ” ìƒíƒœì—ì„œ ë²Œí¬ ì—°ì‚°ì„ ë¨¼ì € ì‹¤í–‰í•œë‹¤.
2. ë¶€ë“ì´í•˜ê²Œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì—”í‹°í‹°ê°€ ìžˆìœ¼ë©´ ë²Œí¬ ì—°ì‚° ì§í›„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™” í•œë‹¤.

```java
int resultCount = memberRepository.bulkAgePlus(20);  
em.flush();  
em.clear();

Member findMember = memberRepository.findByUsername("member5").get(0);
```

ì´ëŸ¬ë©´ ì´ˆê¸°í™” ëœë‹¤. í•˜ì§€ë§Œ,EntityManagerë¥¼ ì“°ê³  ì‹¶ì§€ ì•Šë‹¤ë©´ `@Modifying` ì— `clearAutomatically = true` ì˜µì…˜ì„ ë‹¬ì•„ì£¼ë©´ ëœë‹¤.

```java {1}
@Modifying(clearAutomatically = true)  
@Query("update Member m set m.age = m.age + 1 where m.age >= :age")  
int bulkAgePlus(@Param("age") int age);
```
