# HAVING

쇼핑몰의 카테고리별 실적은 알겠는데, 이 중에서 **매출액이 50만 원을 넘는 핵심 카테고리만** 따로 보고 싶어.
```sql
SELECT
	category,
	SUM(price * quantity) AS total_sales
FROM
	order_stat
GROUP BY
	category;
```
![[assets/images/71ca6fb586472d79825bff83310948a4_MD5.png]]

`WHERE` 절로 해결할 수 있을까?
```sql
SELECT
	category,
	SUM(price * quantity) AS total_sales
FROM
	order_stat
WHERE
	SUM(price * quantity) >= 500000
GROUP BY
	category;
``````
Error Code: 1111. Invalid use of group function
```
오류 발생.
`WHERE` 절은 그룹화가 이루어지기 전, 즉 **테이블의 개별 행 하나하나에 대해 조건을 검사하기 때문**. `SUM()` 과 같은 집계 함수는 `GROUP BY` 를 통해 여러 행이 하나의 그룹으로 묶인 후에야 계산될 수 있는 값임. 따라서 `WHERE` 절의 입장에서는 아직 존재하지도 않는 값을 조건으로 사용하려 해서 오류.

**SQL 작동 순서**: `FROM` -> `WHERE` -> `GROUP BY` -> `…` `SELECT` -> `ORDER BY`

**그룹으로 묶은 결과에 대해 다시 필터링**을 하고 싶을 때, SQL은 `HAVING` 이라는 도구를 제공함.

## WHERE, HAVING 개념 비유

1. 전체 학생(테이블 데이터)들이 운동장에 모여있다.
2. 선생님이 "안경 쓴 학생들만 앞으로 나와!"라고 외친다. (`WHERE`: 개별 행 필터링)
3. 앞으로 나온 학생들을 대상으로 "같은 반 학생들끼리 모여!"라고 한다. (`GROUP BY`: 그룹화)
4. 반별로 모인 그룹들을 보며 선생님이 마지막으로 "이 중에서, 반 평균 점수가 80점 이상인 그룹만 남아!"라고 외친다. (`HAVING`: 그룹 필터링)

`WHERE` 는 그룹화 이전에 개개인을 걸러내는 조건이고, `HAVING` 은 그룹화 이후에 그룹 자체를 걸러내는 조건인 것.

## 그룹을 위한 필터: `HAVING` 절의 사용법

`HAVING` 절은 `GROUP BY` 절 바로 뒤에 위치하며, 그룹화된 결과에 대한 조건을 지정하는 역할. `WHERE` 가 원본 데이터의 개별 행을 위한 필터라면, `HAVING` 은 `GROUP BY` 를 통과한 그룹을 위한 필터다.

- **개념 설명**: `HAVING` 절의 조건문에는 `SUM()`, `COUNT()`, `AVG()` 같은 집계 함수를 사용할 수 있음. `GROUP BY` 를 통해 생성된 여러 그룹들 중에서 `HAVING` 절의 조건을 만족하는 그룹들만 최종 결과에 포함.
- **작동 순서**: `FROM` `WHERE` `GROUP BY` `HAVING` `SELECT` `ORDER BY` 순서로 동작. `GROUP BY` 로 그룹을 만들고, `HAVING` 으로 그 그룹들을 걸러냄.
```sql
SELECT
	category,
	SUM(price * quantity) AS total_sales
FROM
	order_stat
GROUP BY
	category
HAVING
	SUM(price * quantity) >= 500000;
```
![[assets/images/3794a353985ac930361aa06665a8639e_MD5.png]]

## `WHERE` vs `HAVING`: 무엇이, 언제 다른가?

| 구분       | WHERE         | HAVING                  |
| -------- | ------------- | ----------------------- |
| 작옫 시점    | `GROUP BY` 이전 | `GROUP BY` 이후           |
| 필터링 대상   | 개별 행 (Row)    | 그룹 (Group)              |
| 사용 가능 함수 | 집계 함수 사용 불가   | 집계 함수 사용 가능             |
| 역할       | 개발 행을 선택      | 그룹화된 결과 중 조건에 맞는 그룹만 선택 |
