# Middleware

> [ì¶œì²˜](https://velog.io/@jay/Next.js-13-master-course-middleware)

Next.js v13 ì´í›„ ë²„ì „.

middlewareëŠ” v12.0.0ì— ë°°íƒ€ë¡œ ë‚˜ì™”ê³ , v12.2.0ì—ì„œ stable ìƒíƒœê°€ ë˜ì—ˆìœ¼ë©°, v13 ì—ì„œ Next.jsê°€ RSC ë•Œë¬¸ì— ëŒ€ ê²©ë³€ì„ ê²ªê³  ìˆìŒì—ë„ v12 ì™€ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šë‹¤.

![[assets/images/c191682739d2d23ab599472461ccd6a4_MD5.png]]

---

route handlerë¥¼ í†µí•´ ì„œë²„ë¡œ ì˜¤ëŠ” ìš”ì²­ì„ ì²˜ë¦¬í–ˆë‹¤ë©´ middlewareëŠ” route handlerë¥¼ ê±°ì¹˜ê¸° ì „ íŠ¹ì • ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

![[assets/images/2734ad02b38721de3de042c10a5c690a_MD5.png]]

ìš°í¸ ë©”ì‹œì§€ê°€ ë„ì°©ì§€ì— ë„ì°©í•˜ê¸° ì „ ë´‰íˆ¬ì— ë„£ì–´ì§€ëŠ” ê²ƒê³¼ ê°™ì€ íš¨ê³¼.

ì•„ë˜ ì¼ë“¤ì„ í•  ìˆ˜ ìˆë‹¤.

- ì¸ì¦(ì¿ í‚¤ ì²˜ë¦¬)
- êµ­ê°€ë³„ í˜ì´ì§€ ì²˜ë¦¬
- í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì§• ì²˜ë¦¬
- ë´‡ íƒì§€ ë° ì ‘ê·¼ ì œí•œ
- ë¦¬ë‹¤ì´ë ‰íŠ¸ / rewrite
- A/B í…ŒìŠ¤íŠ¸
- ë¡œê¹…

## middleware.ts

13 ë²„ì „ë¶€í„°ëŠ” app ë””ë ‰í† ë¦¬ì™€ ë™ì¼í•œ ìœ„ì¹˜ì— `middleware.ts` íŒŒì¼ì„ ìƒì„±í•´ì•¼ í•¨. ì´ëŠ” Next.jsì˜ special filesì˜ ì¼ì¢…ì´ë‹¤.
```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
 
// This function can be marked `async` if using `await` inside
export function middleware(request: NextRequest) {
  return NextResponse.redirect(new URL('/home', request.url));
}
 
export const config = {
  matcher: '/about/:path*',
};
```
## Matcher

next.js ì„œë²„ê°€ ì²˜ë¦¬í•˜ëŠ” routeë¥¼ ëŒ€ìƒìœ¼ë¡œë„ ë™ì‘í•œë‹¤. íŠ¹ì • pathë¡œë§Œ ë¯¸ë“¤ì›¨ì–´ê°€ ë™ì‘í•˜ê²Œ í•˜ê³  ì‹¶ë‹¤ë©´ matcherë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. configê°€ í•´ë‹¹ ì—­í• ì„ í•œë‹¤. configëŠ” `middleware.ts` ì— ì¡´ì¬í•´ì•¼ í•¨.
```ts
export const config = {
  matcher: '/about/:path*',
};
```
ë‹¤ì–‘í•œ pathë¥¼ ëŒ€ìƒìœ¼ë¡œ matcherë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ì„ ì–¸í•œë‹¤. ì•„ë˜ ì½”ë“œëŠ” `/about` ì´í•˜ pathì™€ `/dashboard` ì´í•˜ pathë¡œ í•­ìƒ middlewareê°€ ë™ì‘í•˜ê²Œ í•œë‹¤.
```ts
export const config = {
  matcher: ['/about/:path*', '/dashboard/:path*'],
};
```
ì´ matcherëŠ” ì •ê·œë¶„í¬ì‹ìœ¼ë¡œ ì‘ì„±ë  ìˆ˜ ìˆìœ¼ë©° ì—­ì°¸ì¡° ë¬¸ë²• ë˜í•œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì•„ë˜ ì½”ë“œëŠ” route handler, ì •ì  íŒŒì¼, facivon.icoë¥¼ ì œì™¸í•˜ê³  ë¯¸ë“¤ì›¨ì–´ê°€ ë™ì‘í•˜ê²Œ í•œë‹¤.
```ts
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - api (API routes)
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     */
    '/((?!api|_next/static|_next/image|favicon.ico).*)',
  ],
};
```
## ë™ì‘ matcherëŠ” ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤

í•œ ê°€ì§€ ì£¼ì˜ ì ì€ matcherëŠ” ë¹Œë“œ íƒ€ì„ì— next.js ì„œë²„ì— ìƒì„±ë˜ì–´ ì ìš©ë˜ê¸° ë•Œë¬¸ì— ë™ì ì¸ ê°’ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤. ë™ì  match configëŠ” ë¬´ì‹œëœë‹¤.

<br/>

# ì¡°ê±´ë¬¸

ë§Œì•½ ë™ì  ê°’ìœ¼ë¡œ matcherë¥¼ ì‘ë™ì‹œí‚¤ê³  ì‹¶ê±°ë‚˜ pathê°€ ë™ì¼í•˜ë”ë¼ë„ íŠ¹ì • ì¡°ê±´ì—ë§Œ middlewareë¥¼ ì‘ë™ì‹œì¼œì•¼ í•œë‹¤ë©´ ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ ë‚´ë¶€ì— `ì¡°ê±´ë¬¸` ì—ì„œ ì´ë¥¼ ì¶©ì¡±ì‹œí‚¬ ìˆ˜ ìˆë‹¤.

## NextResponse

ì•„ë˜ ì½”ë“œëŠ” ë¯¸ë“¤ì›¨ì–´ì—ì„œ responseë¥¼ ìƒì„±í•´ ì‚¬ìš©ìì—ê²Œ ë°”ë¡œ ì‘ë‹µì„ ì „ë‹¬í•œë‹¤.
```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
 
export function middleware(request: NextRequest) {
  if (request.nextUrl.pathname.startsWith('/about')) {
    return NextResponse.rewrite(new URL('/about-2', request.url));
  }
 
  if (request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.rewrite(new URL('/dashboard/user', request.url));
  }
}
```
NextResponseë¥¼ í†µí•´ ì‚¬ìš©ìë¥¼ íŠ¹ì • urlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹œí‚¤ê±°ë‚˜ ìš”ì²­í•œ urlì€ ê·¸ëŒ€ë¡œ ë…¸ì¶œí•˜ë©´ì„œ íŠ¹ì • ê²½ë¡œë¡œ ì´ë™ì‹œí‚¤ëŠ” rewriteë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

<br/>

# NextResponse.nextë¡œ Middleware ì‹¤í–‰ í›„ route handlerë„ ì‹¤í–‰ì‹œí‚¤ê¸°

NextResponse í´ë˜ìŠ¤ì˜ next ë©”ì„œë“œ í˜¸ì¶œì„ í†µí•´ NextResponse ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.
```ts
export function middleware(request: NextRequest) {
  const newRequestHeaders = new Headers(request.headers);
  newRequestHeaders.set("some-thing", "something from headers");

  const response = NextResponse.next({
    request: {
      headers: newRequestHeaders,
    },
  });

  response.cookies.set({
    name: "hi",
    value: "bye",
    path: "/",
  });
  return response;
}
```
ë¯¸ë“¤ ì›¨ì–´ì—ì„œ ë°˜í™˜í•˜ëŠ” response ê°ì²´ê°€ NextResponse.nextì—ì„œ ìƒì„±ëœ NextResponseë¼ë©´, route handlerì—ì„œë„ request ê°ì²´ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

â­ì¦‰, `NextResponse.next()` ë©”ì„œë“œë¥¼ í†µí•´ API Routesë¡œ ë°”ë¡œ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŒ.

ğŸ“Œì´ ë•Œ, next ë©”ì„œë“œì—ì„œ ë°›ì•„ë“¤ì´ëŠ” ì¸ìë¡œ header ê°’ë§Œ ì •ì˜í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— middlewareì—ì„œ route handlerë¥¼ ê±°ì¹˜ì§€ ì•Šê³ ì„œëŠ” response bodyë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ë‹¤ëŠ” íŠ¹ì§•ì´ ìˆë‹¤.

ì•ì„  ì˜ˆì œ ì½”ë“œì—ì„œëŠ” route handlerì—ì„œ ì¸ìë¡œ ë°›ì„ request ê°ì²´ì˜ header ê°’ì— ìƒˆë¡œìš´ í—¤ë” ê°’ì„ ì„¤ì •í•œë‹¤.

ê·¸ë¦¬ê³  `app/api/post/route.ts` ì—ì„œ í—¤ë” ê°’ì„ ì½ëŠ”ë‹¤.
```ts
import { headers } from "next/headers"
import { NextRequest, NextResponse } from "next/server"
export async function GET(request: NextRequest) {
  const httpHeaders = headers()
  console.info("httpHeaders: ", httpHeaders)
  console.info("request.headers: ", request.headers)
  // console.info("hi this is GET")
  // ...
}
```
route handler ì—ì„œ í—¤ë”ë¥¼ ì½ëŠ” ë°©ë²•ì€, ì¸ìë¡œ ì „ë‹¬ëœ request ê°ì²´ì˜ headersë¥¼ ì°¸ì¡°í•˜ëŠ” ë°©ë²•ê³¼ next/serverì—ì„œ ì œê³µí•˜ëŠ” header apië¥¼ ì‚¬ìš©í•˜ëŠ” ë‘ ê°€ì§€ ë°©ë²•ì´ ìˆë‹¤. ë‘ ë°©ë²• ëª¨ë‘ ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì„¤ì •í•œ headerë¥¼ ì½ì„ ìˆ˜ ìˆê³ , í—¤ë” ë‚´ë¶€ ê°’ì€ ë™ì¼í•˜ë‹¤.

<br/>

# ì¿ í‚¤, nextUrl ì˜ˆì œ

NextRequestëŠ” Request ê°ì²´ë¥¼ í™•ì¥í•œ ê²ƒì´ê¸° ë•Œë¬¸ì— ê°œë°œì„ ê°„í¸í•˜ê²Œ í•´ì£¼ëŠ” ì†ì„±ì´ ìˆë‹¤. `request.url`ì´ ì•„ë‹Œ, `request.nextUrl`ì„ ì‚¬ìš©í–ˆë‹¤.
```js
// /homeìœ¼ë¡œ ì ‘ê·¼í–ˆì„ë•Œ  pathnameì€ /homeì´ ë©ë‹ˆë‹¤.
request.nextUrl.pathname;
//  /home?name=lee ìœ¼ë¡œ ì ‘ê·¼í–ˆì„ë•Œ  searchParams ì€ { 'name': 'lee' }ì´ ë©ë‹ˆë‹¤.
request.nextUrl.searchParams;
```
ì¦‰, requestë¥¼ í™•ì¥í–ˆë‹¤ëŠ ã„´ëœ»ì„. ë” ë§ì€ ì •ë³´ë¥¼ ì†ì‰½ê²Œ ì–»ì„ ìˆ˜ ìˆìŒ.

## ì¿ í‚¤ ì„¤ì •

NextRequest íƒ€ì…ì¸ request ì¸ìì˜ cookie ì†ì„±ì„ í†µí•´ ìš”ì²­ëœ request ì¿ í‚¤ ê°’ì„ ì½ìœ½ ìˆ˜ ìˆê³ , `NextResponse` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±, cookies.set ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ ì¿ í‚¤ë¥¼ ì„¤ì •í•´ì¤„ ìˆ˜ë„ ìˆìŒ.
```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
 
export function middleware(request: NextRequest) {
  // Assume a "Cookie:nextjs=fast" header to be present on the incoming request
  // Getting cookies from the request using the `RequestCookies` API
  let cookie = request.cookies.get('nextjs')?.value;
  console.log(cookie); // => 'fast'
  const allCookies = request.cookies.getAll();
  console.log(allCookies); // => [{ name: 'nextjs', value: 'fast' }]
 
  request.cookies.has('nextjs'); // => true
  request.cookies.delete('nextjs');
  request.cookies.has('nextjs'); // => false
 
  // Setting cookies on the response using the `ResponseCookies` API
  const response = NextResponse.next();
  response.cookies.set('vercel', 'fast');
  response.cookies.set({
    name: 'vercel',
    value: 'fast',
    path: '/',
  });
  
  cookie = response.cookies.get('vercel');
  console.log(cookie); // => { name: 'vercel', value: 'fast', Path: '/' }
  // The outgoing response will have a `Set-Cookie:vercel=fast;path=/test` header.
 
  return response;
}
```
---

ë¯¸ë“¤ì›¨ì–´ëŠ” edge function ì—ì„œë„ ì‘ë™í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì–´ pages directoryì˜ middlewareì™€ëŠ” ë‹¤ë¥¸ ë¶€ë¶„ì´ ìˆë‹¤.
