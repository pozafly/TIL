# ì¬ì‚¬ìš©í•˜ê¸°

> [ì¶œì²˜](https://www.daleseo.com/github-actions-reusable-workflows/)

ì¤‘ë³µ ë¬¸ì œ í•´ê²°ì„ ìœ„í•¨.

```yaml
name: Our Deployment
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: check out
        uses: actions/checkout@v3
      - name: set up node
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: npm
      - name: install
        run: npm ci
      - name: test
        run: npm test
      - name: build
        run: npm run build
      - name: deploy
        run: npm run deploy
```

<br/>

## í™˜ê²½ ë³„ë¡œ ì‘ì—… ë¶„ë¦¬

í™˜ê²½ ë³„ë¡œ ë°°í¬ë¥¼ í•˜ê¸° ìœ„í•´ì„œ `deploy` ì‘ì—…ì„ `deploy-dev`, `deploy-qa`, `deploy-prod` ì´ë ‡ê²Œ 3ê°œì˜ ì‘ì—…ìœ¼ë¡œ ë¶„ë¦¬í•´ë³´ì.

```yaml
name: Our Deployment
on:
  push:
    branches: [main]
jobs:
  deploy-dev:
    # here
    environment: dev
    runs-on: ubuntu-latest
    steps:
      - name: check out
        uses: actions/checkout@v3
      - name: set up node
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: npm
      - name: install
        run: npm ci
      - name: test
        run: npm test
      - name: build
        run: npm run build
      - name: deploy
        run: npm run deploy

  deploy-qa:
    # here
    needs: [deploy-dev]
    # here
    environment: qa
    runs-on: ubuntu-latest
    steps:
      - name: check out
        uses: actions/checkout@v3
      - name: set up node
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: npm
      - name: install
        run: npm ci
      - name: test
        run: npm test
      - name: build
        run: npm run build
      - name: deploy
        run: npm run deploy

  deploy-prod:
    # here
    needs: [deploy-qa]
    # here
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - name: check out
        uses: actions/checkout@v3
      - name: set up node
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: npm
      - name: install
        run: npm ci
      - name: test
        run: npm test
      - name: build
        run: npm run build
      - name: deploy
        run: npm run deploy
      - name: notify
        run: echo 'Deployment completed in prod! ğŸ‰'
```

ìƒë‹¹íˆ ê¸¸ë‹¤. í•˜ì§€ë§Œ, ê±°ì˜ ë¹„ìŠ·í•œ stepì„ ê°€ì§€ê³  ìˆë‹¤.

ë‹¤ë¥¸ ë¶€ë¶„ì€ `environment` ì†ì„±ì„ í†µí•´ ê° ì‘ì—…ì˜ ë‹¤ë¥¸ ë°°í¬ í™˜ê²½ì„ ì§€ì •í•˜ëŠ” ê²ƒ ë°–ì— ì—†ë‹¤. `deploy-dev`, `deploy-qa`, `deploy-prod` ìˆœìœ¼ë¡œ ì‘ì—…ì´ ìˆ˜í–‰ë˜ë„ë¡ `needs` ì†ì„±ì„ ì‚¬ìš©í•´ ì‘ì—… ê°„ ì˜ì¡´ ê´€ê³„ë¥¼ ì„¤ì •í•´ì£¼ê³  ìˆë‹¤.

![image](https://github.com/pozafly/TIL/assets/59427983/1d0780af-1348-459c-b375-f58b1f5120a5)

3ê°œì˜ ì‘ì—…ì´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

<br/>

## ìƒì„±

ë³µë¶™ ëŒ€ì‹  ì‚¬ìš©í•  ìˆ˜ ìˆìŒ. 3ê°œì˜ ì‘ì—…ì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ì„¤ì •ë˜ëŠ” ë¶€ë¶„ì„ ì¶”ì¶œ, ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°ëŠ” `workflow_call` ì´ë¼ëŠ” ì´ë²¤íŠ¸ì— ë°˜ì‘í•´ ì…ë ¥ ì¸ìë¥¼ ì •ì˜í•´ì¤„ ìˆ˜ ìˆìŒ.

```yaml
name: Our Reusable
on:
  # here
  workflow_call:
    inputs:
      env:
        type: string
        required: true
      notify:
        type: boolean
        default: false

jobs:
  deploy:
    # here
    environment: inputs.env
    runs-on: ubuntu-latest
    steps:
      - name: check out
        uses: actions/checkout@v3
      - name: set up node
        uses: actions/setup-node@v3
        with:
          node-version-file: ".nvmrc"
          cache: npm
      - name: install
        run: npm ci
      - name: test
        run: npm test
      - name: build
        run: npm run build
      - name: deploy
        run: npm run deploy
      - name: notify
        # here
        if: inputs.notify
        run: echo 'Deployment completed in ${{ inputs.env }}! ğŸ‰'
```

ì…ë ¥ ì¸ìë¡œ ë„˜ì–´ì˜¨ ë¬¸ìì—´ ìë£Œí˜•ì˜ `env` ê°’ì„ ê·¸ëŒ€ë¡œ `encironment` ì†ì„±ì— ì„¤ì •í•´ì£¼ê³ , ë¶ˆë¦¬ì–¸ ìë£Œí˜•ì˜ `notify` ê°’ì´ `true` ë¡œ ë„˜ì–´ì™”ì„ ë•Œë§Œ `notify` ë‹¨ê³„ë¥¼ ì‹¤í–‰í•˜ê³  ìˆë‹¤.

<br/>

## í˜¸ì¶œ

`uses` ì†ì„±ì„ í†µí•´ ê° ì‘ì—…ì— ì¬ì‚¬ìš© ì›Œí¬í”Œë¡œìš°ê°€ ìœ„ì¹˜í•œ ê²½ë¡œë¥¼ ì§€ì •í•œë‹¤. ê·¸ë¦¬ê³  `with` ì†ì„±ì„ í†µí•´ ì¸ìë¥¼ ëª…ì‹œí•˜ë©´ ëœë‹¤.

```yaml
name: Our Deployment
on:
  push:
    branches: [main]
jobs:
  deploy-dev:
    uses: ./.github/workflows/reusable.yml
    with:
      env: dev

  deploy-qa:
    needs: [deploy-dev]
    uses: ./.github/workflows/reusable.yml
    with:
      env: qa

  deploy-prod:
    needs: [deploy-qa]
    uses: ./.github/workflows/reusable.yml
    with:
      env: prod
      notify: true
```

ìƒìš© ë°°í¬ì— ëŒ€í•´ì„œë§Œ ì•ŒëŒì´ ì˜¤ë„ë¡ `deploy-prod` ì‘ì—…ì—ì„œë§Œ `notify`ë¥¼ `true`ë¡œ ì£¼ ìˆë‹¤.
