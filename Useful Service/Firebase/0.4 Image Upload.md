# Image Upload

<br/>

## 1. React ì •ì˜

Cloudinaryì— ì‘ì„±ë˜ì–´ ìˆëŠ” REST API ë°©ë²•ëŒ€ë¡œ js íŒŒì¼ë¶€í„° ì •ì˜í•´ë³´ì.

```javascript
// image_uploader.js
class ImageUploader {
  async upload(file) {
    const data = new FormData();
    data.append('file', file);
    data.append('upload_preset', process.env.REACT_APP_CLOUDINARY_ACCOUNT);
    const res = await fetch(`https://api.cloudinary.com/v1_1/${process.env.REACT_APP_CLOUDINARY_CLOUDNAME}/upload`,
      {
        method: 'POST',
        body: data,
      }
    );
    return await res.json();
  }
}

export default ImageUploader;
```

ì´ì œ ì´ê±¸ ì‚¬ìš©í•  react ì»´í¬ë„ŒíŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì. `<ImageFileInput />` ì´ê±¸ ë§Œë“¤ ê²ƒì„.

- ì‚¬ìš©ì ì´ë¦„ì„ ë°›ì•„ì™€ì•¼ í•¨.
- íŒŒì¼ì´ ë°”ë€Œë©´ ë¶ˆëŸ¬ì¤„ ìˆ˜ ìˆëŠ” ì½œë°±ë„ í•„ìš”.

```jsx
// file_input.jsx
import React, { useRef } from 'react';
import styles from './image_file_input.module.css';

const FileInput = ({ imageUploader, name, onFileChange }) => {
  const inputRef = useRef();
  const onButtonClick = (event) => {
    event.preventDefault();
    inputRef.current.click();  // ìˆ˜ë™ì ìœ¼ë¡œ click ë°œìƒì‹œí‚¤ê¸°
  };

  const onChange = async (event) => {
    // image_upload.js ë¡œë¶€í„° ë°›ì•„ì˜¨ upload() í•¨ìˆ˜
    const uploaded = await imageUploader.upload(event.target.files[0]);
    onFileChange({   // onFileChange ëŠ” props ë¡œ ë°›ì•˜ë‹¤.
      name: uploaded.original_filename,
      url: uploaded.url,
    });
  };

  return (
    <div className={styles.container}>
      <input
        ref={inputRef}
        className={styles.input}
        type='file'
        accept='image/*'   // ì´ë¯¸ì§€ í™•ì¥ìë§Œ ë°›ê² ë‹¤
        name='file'
        onChange={onChange}   // ì²´ì¸ì§€ ë˜ë©´, ì¦‰, íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ë©´
      />
      <button className={styles.button} onClick={onButtonClick}>
        {name || 'No file'}
      </button>
    </div>
  );
};

export default FileInput;
```

ì´ë ‡ê²Œ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‘ì„±í•´ì¤¬ë‹¤. ê·¸ëŸ¬ë©´ propsë¡œ ë°›ëŠ” `onFileChange()` ë¥¼ ì •ì˜í•œ ê³³ì—ì„œ propsë¥¼ ì •ì˜í•´ì£¼ì–´ì•¼ ê² ì§€?

```jsx
// ìƒìœ„ ì»´í¬ë„ŒíŠ¸
...
const [file, setFile] = useState({ fileName: null, fileURL: null });
...
const onFileChange = (file) => {
  setFile({
    fileName: file.name,
    fileURL: file.url,
  });
};
...
<FileInput name={file.fileName} onFileChange={onFileChange} />
```

fileì´ë¼ëŠ” stateë¥¼ ì„ ì–¸í•˜ê³ , onFileChangeê°€ ì¼ì–´ë‚˜ë©´ setFile() ë¡œ stateë¥¼ ì—…ëƒ ì‹œì¼œì¤€ë‹¤. ê·¸ëŸ¬ë©´ name={file.fileName} ìœ¼ë¡œ propsë¡œ name ì´ ë„˜ì–´ê°ˆ ê²ƒì´ê³  buttonì— nameì´ í‘œí˜„ ëœë‹¤.

<br/>

## 2. Firebase ì‹¤ì‹œê°„ Database Set, Remove

[Docs](https://firebase.google.com/docs/database/web/read-and-write)

- ë¨¼ì € Firebase console ì— ê°€ì„œ ì™¼ìª½ íƒ­ì— Develop -> `Realtime Database` ë¥¼ ëˆŒëŸ¬ì„œ ë“¤ì–´ê°€ë©´, Create Databaseë¥¼ ëˆŒëŸ¬ì£¼ì.
- ![ìŠ¤í¬ë¦°ìƒ· 2021-03-02 ì˜¤í›„ 5 23 51](https://user-images.githubusercontent.com/59427983/109619419-1ac1c600-7b7c-11eb-99eb-5cc8e207b5bd.png)
- ì´ë ‡ê²Œ ë¹ ë¥´ê²Œ ì‹œì‘í•  ìˆ˜ ìˆê²Œ locked ëª¨ë“œ ë§ê³ , test ëª¨ë“œë¡œ í•´ì£¼ì–´ì•¼ ê³µìš©ìœ¼ë¡œ ì½ê³  ì“°ê¸°ê°€ ê°€ëŠ¥í•¨.

<br/>

ë‹¨, ì´ì œ ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ë³„ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì–´ì•¼ í•œë‹¤. ê·¸ë˜ì•¼ ì‚¬ìš©ì ë³„ë¡œ í•´ë‹¹í•˜ëŠ” ì¹´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

```jsx
// login.jsx
const goToMaker = (userId) => {
  history.push({
    pathname: '/maker',
    state: { id: userId },
  });
};
```

ì´ê³³ì—ë‹¤ê°€ historyì— stateì— ì‚¬ìš©ìì˜ id ë¥¼ ë‹´ëŠ” ì‘ì—…ì„ í–ˆì—ˆë‹¤. ì´ idë¥¼ maker.jsx ì»´í¬ë„ŒíŠ¸ ì•ˆì— stateë¡œ ì €ì¥í•  ê²ƒì´ë‹¤.

```jsx
// maker.jsx
const history = useHistory();
const historyState = history?.location?.state;
const [cards, setCards] = useState({});
const [userId, setUserId] = useState(historyState && historyState.id);
```

ì´ë ‡ê²Œ userId stateë¥¼ ì„ ì–¸í•  ìˆ˜ ìˆê² ì§€?

- `useHistroy()`ëŠ” react-router-dom ì—ì„œ ì œê³µí•˜ëŠ” hookì„.
- histroyStateì—ëŠ” login.jsxì—ì„œ ë³´ë‚¸ state: { id: userId } ê°€ ë“¤ì–´ìˆê² ì§€? ì´ê±¸ stateì˜ ì´ˆê¹ƒê°’ìœ¼ë¡œ ë„£ì–´ì¤Œ.

```jsx
// maker.jsx
useEffect(() => {
  authService.onAuthChange((user) => {
    if (user) {
      setUserId(user.uid);
    } else {
      history.push('/');
    }
  });
});
```

ì´ì œ jsë¥¼ ë§Œë“¤ ê²ƒì„. service ë””ë ‰í† ë¦¬ì— card_repository.jsë¥¼ ë§Œë“¤ì. ì§€ê¸ˆ ë§Œë“œëŠ” ê²ƒì€ [ê³µì‹ read & write](https://firebase.google.com/docs/database/web/read-and-write#basic_write) ì—¬ê¸° ê°€ë©´ ì„¤ëª…ì´ ì˜ ë‚˜ì™€ ìˆë‹¤.

```javascript
// ì—¬ê¸°ì— ì‚¬ìš©ëœ firebase.js ëŠ” 0.1 Firebase setup.md ì— ì˜ ë‚˜ì™€ ìˆë‹¤.
import firebaseApp from './firebase';

class CardRepository {
  saveCard(userId, card) {
    // 1. ë°ì´í„°ë² ì´ìŠ¤ api, ìœ ì € Id ë¼ëŠ” í´ë”ì—, cards ë¼ëŠ” ë””ë ‰í† ë¦¬ì— card idë¡œ ëœ í´ë”ì— ì €ì¥í•  ê²ƒì´ë‹¤.
    // 2. ë¬´ì—‡ì„? set() í•¨ìˆ˜ ì•ˆì— ìˆëŠ” card ê°ì²´ë¥¼.
    firebaseApp.database().ref(`${userId}/cards/${card.id}`).set(card);
  }
  removeCard() {
    // í•´ë‹¹ ë””ë ‰í† ë¦¬ë¥¼ ì‚­ì œí•´ë²„ë¦¼.
    firebaseApp.database().ref(`${userId}/cards/${card.id}`).remove();
  }
}

export default CardRepository;
```

ê·¸ëŸ¬ë©´ ì´ì œ ì‚¬ìš©ë˜ëŠ” ê³³ì—ì„œ ì‚¬ìš©í•´ì£¼ì–´ì•¼ í•¨. maker.jsx.

- ì‚¬ìš©ìê°€ ì—…ë°ì´íŠ¸ í–ˆì„ ë•Œ database ì— ë„£ì–´ì£¼ê³ ,
- ì‚¬ìš©ìê°€ ì‚­ì œ í–ˆì„ ë•Œ databaseì—ë„ ì‚­ì œí•´ì£¼ê³ .

```jsx
// maker.jsx
const createOrupdateCard = (card) => {
  ...
  cardRepository.saveCard(userId, card);  // ì—¬ê¸° ë¶€ë¶„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤.
};

const deleteCard = (card) => {
  ...
  cardRepository.removeCard(userId, card);
};
```

ê·¸ëŸ¬ë©´ ì¹´ë“œë¥¼ í•˜ë‚˜ ì¶”ê°€í•˜ê³ , ìˆ˜ì •í•´ë³´ë©´

<img width="558" alt="ìŠ¤í¬ë¦°ìƒ· 2021-03-02 ì˜¤í›„ 6 10 54" src="https://user-images.githubusercontent.com/59427983/109625411-a63e5580-7b82-11eb-812a-848d2d160f0f.png">

ì´ë ‡ê²Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°”ë¡œë°”ë¡œ ë³€ë™ë˜ëŠ”ê±¸ ë³¼ ìˆ˜ ìˆë‹¤. ë„ˆëª¨ ì‹ ê¸°í•˜ê³ .

<br/>

## 3. ì‹¤ì‹œê°„ Database Sync

ê·¼ë° í•œê°€ì§€ ë¬¸ì œì ì´ ìˆì‚¼. í˜ì´ì§€ì—ì„œ ìƒˆë¡œê³ ì¹¨ í•˜ë©´ í……í…… ë¹ˆ í™”ë©´ì´ ë³´ì´ëŠ”ë°, DB ê°’ê³¼ ì‹±í¬ë¥¼ ë§ì¶°ì£¼ëŠ” ì‘ì—…ì„ í•  ê²ƒì„.

[ê³µì‹ Listen for value events](https://firebase.google.com/docs/database/web/read-and-write#listen_for_value_events)

ì—¬ê¸°ì—ì„œ ë³´ë©´, `on()` í•¨ìˆ˜ë¡œ ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë“¤ì„ ìˆ˜ ìˆê³ , `once()`ë¥¼ ì´ìš©í•´ì„œ 1ë²ˆë§Œ ë“¤ì„ ìˆ˜ ìˆë‹¤ê³  í•¨. ê·¸ë¦¬ê³  ë”ì´ìƒ ë³€ê²½ ì‚¬í•­ì„ ë“£ê³  ì‹¶ì§€ ì•Šë‹¤ë©´, `off()` ë¥¼ ì‚¬ìš©í•´ì„œ ë„ë©´ ë¨. ğŸ“Œ ì´ê±¸ í‘œí˜„í•˜ëŠ” componentê°€ unmount ë˜ì–´ ì‚¬ìš©ìê°€ ë”ì´ìƒ databaseë¥¼ ë“£ê³  ìˆì§€ ì•ŠëŠ”ë° ë„¤íŠ¸ì›Œí¬ ìì›ì„ ì‚¬ìš©í•˜ë©´ ì•ˆë˜ë‹ˆ off ì‘ì—…ì€ ë°˜ë“œì‹œ í•„ìš”í•˜ê² ì§€?

```javascript
// card_repository.js
syncCard(userId, onUpdate) {
  // userId ì•ˆì— ìˆëŠ” ëª¨ë“  cards ì— ëŒ€í•´ì„œ ë“£ê² ë‹¤.
  const ref = firebaseApp.database().ref(`${userId}/cards`);
  ref.on('value', (snapshot) => {  // onì€ snapshot ì´ë¼ëŠ” valueë¥¼ returní•¨.
    const value = snapshot.val();
    value && onUpdate(value);  // valueê°€ ì¡´ì¬í•˜ë©´ ì½œë°±ìœ¼ë¡œ ì „ë‹¬ë°›ì€ onUpdateë¥¼ ì‹¤í–‰í•˜ê² ë‹¤.
  });
  return () => ref.off();
}
```

ì´ë ‡ê²Œ on(), off() í•¨ìˆ˜ë¥¼ í†µí•´ ë§Œë“¤ì–´ì¤¬ë‹¤. ì—¬ê¸°ì„œ returnì€, `() => ref.off()` ë¥¼ ì‚¬ìš©í–ˆëŠ”ë°, syncCard() ë¼ëŠ” ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ ë„ëŠ” í•¨ìˆ˜ë¥¼ return í•´ì¤„ ê²ƒì´ë‹¤. ê·¸ëŸ¬ë©´ syncCard() í•¨ìˆ˜ë¥¼ ë¶€ë¥¼ ë•Œë§ˆë‹¤ ë„ëŠ” í•¨ìˆ˜ë¥¼ ë°›ì•„ì˜¤ê² ì§€?

```jsx
// maker.jsx
useEffect(() => {
  if (!userId) return;
  const stopSync = cardRepository.syncCard(userId, (cards) => {  // ì´ ì½œë°± í•¨ìˆ˜ëŠ” card_repositoryì˜ onUpdate ì½œë°±ìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤.
    setCards(cards);
  });
  // ì—¬ê¸° returnë¬¸ì€ useEffectì—ì„œ ê´€ë¦¬í•˜ëŠ”ë°, ì»´í¬ë„ŒíŠ¸ê°€ unMount ë˜ì—ˆì„ ë•Œ í˜¸ì¶œ.
  return () => stopSync();
}, [userId]);
```

- const stopSync ì—ëŠ” ìœ„ì—ì„œ returní•œ `return () => ref.off()` ì´ë†ˆì´ ë“¤ì–´ê°€ê³ ,
- `return () => stopSync();` ì´ë…€ì„ì´ unMount ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ ë˜ëŠ” ë…€ì„ì´ë‹¤.
