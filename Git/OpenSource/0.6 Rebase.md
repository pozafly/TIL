# Rebase

## 개념

- rebase가 필요한 상황을 잘 이해해야함.
  - base : commit이 쌓이는 것
  - rebase : 기본적으로 쌓인 commit을 수정 후, 기본 commit을 재구성 한다는 뜻.
- 베이스만 바꾸자. 최신 역사로 베이스 업데이트.
- 왜 하냐?
  - 내가 fork 한 저장소에서 소스를 수정하고 있는데, 다른 사람도 자신이 fork한 repo에서 수정되어 PR을 날려서 원본 repo가 변경이 된 상황이다.
  - 그러면, 내 local repo의 base, 즉, 내 repo의 commit 내역도 바뀌어야 된다.(local repo, fork repo 모두)
  - 내 내역이 바뀌어야 원본 소스와 내 local 소스가 동일하게 되어 다시 PR을 날릴 수 있는 상태가 되기 때문이다.

<br/>

## 방법

- 먼저 최신 역사를 가져와야 함. fetch.
  - git pull = fetch + merge 임.
  - 내가 local에서 base가 바뀌면서 merge commit이 생기는 것이기 때문에 merge를 강제로 하지말고 fetch를 먼저 한다는 말임.
  - `git fetch upstream master`
- 이제 rebase 를 할 수 있음.  2단계가 있음.
  - 작업 중 커밋(push 하기 전 commit)을 rebase.
  - `git rebase upstream/master`
  - 후에 force push 해야 한다. 나의 fork 한 저장소에만.

정리하자면, 3단계임

- 누군가 merge한 원본 repo에서 fetch.
- 내 local repo에서 rebase.
- fork한 원격 repo에 force push.

<br/>

## 준비

## Fork 저장소와 오픈소스 Github 저장소 설정

- origin외에 upstream 저장소를 remote에 추가할 것임.

```shell
# 오픈소스 공식 GitHub 프로젝트 URL
# upstream 으로 등록 하기
$ git remote add upstream https://github.com/taeung/pytorch-example

# origin: 나의 Fork 저장소 GitHub URL
# upstream: 오픈소스 공식 GitHub URL (또는 팀프로젝트 URL)
$ git remote -v
origin  https://github.com/나의ID/pytorch-example.git (fetch) 
origin  https://github.com/나의ID/pytorch-example.git (push)
upstream        https://github.com/원본ID/pytorch-example.git (fetch)
upstream        https://github.com/원본ID/pytorch-example.git (push)
```

<br/>

## 실습

### 원본 repo 최신 commit으로 Base 업데이트

```shell
# 공식 upstream 저장소에서 최신 commit history 가져오기
$ git fetch upstream master

# 최신 commit history 기준으로 베이스 갱신 (rebase)
$ git rebase upstream/master

# Fork 한 저장소(GitHub)도 수정하기 (PR 자동 갱신)
$ git push --force origin [브랜치 명]
or
$ git push --f origin [브랜치 명]
```

📌 이렇게 **force push**를 하게 되면, 기존에 내가 남겨둔 PR이 있을 경우 자동으로 갱신된다.

📌 또한 그냥 PR을 수정하고 싶을 때도, **force push**를 사용한다.

📌 위의 2번째 명령어의 `upstream/master` 이 것은 git에서 자동으로 만들어준 브랜치다.

<br/>

<br/>

## Interactive Rebasing

- 과거 시점으로 돌아가서 소스 확인 & 컴파일해서 돌려볼 수 있다.

### commit 과거 시점으로 되감기(rewind)

```shell
# Rebase 실습할 GitHub 저장소 소스폴더 다운받고 이동
$ cd /workspace
$ git clone https://github.com/taeung/git-training 
$ cd git-training

# 가장 오래된 commit 두번째로 되감기 
# 두번째로 가장 오래된 commit 의 "pick" 글자를 "edit" 으로 수정하기
# nano 편집기 저장: ctrl + o 
# nano 편집기 나가기: ctrl + x
$ git rebase -i --root

# 되감기(rewind) 한 commit 리스트 확인하기
$ git log --oneline

# rebase interactive 상태 (되감은 상태) 확인
$ git status

# 참고: --root 대신 최신 commit 기준으로 HEAD~10 10개중에서 선택도 가능하다
```

<br/>

### commit 다시 현재 시점으로 풀기(continue)

```shell
# 되감은 내용 풀기(continue) 이전 상태 확인
$ git log --oneline

# 되감은 내용 풀기(continue)
$ git rebase --continue

# 되감은 내용 풀기(continue) 이후 상태 확인
$ git log --oneline

# 참고: rebase 과정을 취소하려면 --abort 옵션을 사용할 수 있다.  
```

---

📌 rebase에서, abort와 continue의 차이점

- git rebase abort : 리베이스 진행 취소
- git rebase continue : 리베이스를 마친 후 저장 & 진행

<br/>

### 2번째로 오래된 커밋에 hello.txt 빈파일을 추가해서 수정(amend)하고 commit message도 "Add knapsack problem PDF and hello.txt" 로 수정(amend)하기

```shell
# 2번째로 오래된 commit 에 해당되는
# "pick" 글자를 "edit" 글자로 바꾸고 저장하자  
# nano 편집기 저장: ctrl + o 
# nano 편집기 나가기: ctrl + x
$ git rebase -i --root

# hello.txt 빈파일 생성 및 commit 준비
$ touch hello.txt
$ git add hello.txt

# commit message 를 수정하기
# Add knapsack problem PDF and hello.txt
$ git commit --amend

# 되감은 내용 풀기(continue)
$ git rebase --continue

# commit 수정 결과 확인하기
$ git log --oneline

# 2번째로 오래된 commit 에 해당되는 commit ID로  
# commit 내용 확인하기
$ git show "[commit ID]"
```

