# ARP(주소 확인 프로토콜)

네트워크 세계에서 주소를 나타내는 것 2가지
- MAC 주소
	- NIC 자체에 설정하는 주소. 데이터 링크 계층
- IP 주소
	- OS에 설정하는 주소. 네트워크 계층

두 주소가 독립적으로 동작하면 데이터링크 계층, 네트워크 계층의 정보가 일치하지 않아 통신이 이루어지지 않음.

이 두 주소를 연결하는 프로토콜이 '**ARP**'(Address Resolution Protocol) - 주소 확인 프로토콜임. 즉, 2.5계층.

![[assets/images/e472e46ebff36b4c373a55f1c4aa5723_MD5.png]]
데이터 전송 때, 네트워크 계층에서 받은 IP 패킷을 이더넷 프레임으로 캡슐화 해 케이블로 보내야 함.
IP 주소를 받은 것만으로는 이더넷 프레임을 만드는데 필요한 정보가 부족함.
- 발신자 MAC 주소는 자신의 NIC로 알 수 있지만 목적지 MAC 주소는 알 수 없음.
- ARP로 목적지 IP 주소로 MAC 주소를 구함.
- 이를 **주소 확인**이라고 함.

![[assets/images/6cc5bc900c6d1578c864387fdd97a159_MD5.png]]

## ARP 프레임 형식

ARP는 이더넷 헤더의 타입 코드에서 '0x0806'으로 정의. 이더넷 페이로드에 데이터링크 계층과 네트워크 계층 정보를 담아 MAC 주소와 IP를 연결함.

![[assets/images/a360e253486cdc39aeb213594be60656_MD5.png]]

### 하드웨어 유형

- 사용중인 레이어 2 프로토콜을 나타내는 2바이트 필드
- 이더넷의 경우 '0x0001'

### 프로토콜 유형

- 사용중인 레이어 3 프로토콜을 나타내는 2바이트 필드
- IPv4의 경우 '0x0800'

### 하드웨어 주소 크기

- 하드웨어 주소, 즉 MAC 주소의 길이를 바이트 단위로 나타내는 1바이트 필드
- MAC 주소는 48비트 = 6바이트이므로 '6'

### 프로토콜 주소 크기

- 네트워크 계층에서 사용하는 주소, 즉 IP 주소의 길이를 바이트 단위로 나타내는 1바이트
- IPv4의 길이는 32비트 = 4바이트이므로 '4'

### 오퍼레이션 코드(opcode, 동작 코드)

- ARP 프레임의 종류를 나타내는 2바이트 필드
- ARP Request를 나타내는 '1'
- ARP Reply를 나타내는 '2'

### 발신자 MAC 주소/발신자 IP 주소

- 이름 그대로

### 목적지 MAC 주소/목적지 IP 주소

- 처음엔 MAC 주소를 알 수 없으므로 더미 MAC 주소 '00:00:00:00:00:00'을 설정.

## ARP 주소 확인 흐름

**디바이스**
- cl3 (pc)
- rt1 (광대역라우터)

1. cl3는 목적지 IP를 보고 '**ARP 테이블**' 검색
2. cl3는 ARP 필드 정보 조립
	- ARP Request를 나타내는 '1'
	- 발신자 MAC 주소, IP 주소
	- 목적지 MAC 주소는 모르므로 더미(00:00:00:00:00:00), IP 주소는 있으므로 넣음
	- 이더넷 헤더 조립
		- ARP Request는 '브로드캐스트' 사용
		- 따라서 목적지 MAC 주소는 ff:ff:ff:ff:ff:ff
		- 발신자 MAC 자신의 주소
3. 브로드 캐스트 이므로 이더넷 네트워크(가정 내 LAN)에 있는 모든 단말에 전달.
![[assets/images/9be4f4b8f1b882493840f257d14d6d44_MD5.webp]]

4. ARP Request를 받은 rt1은 ARP Reply 회신을 위한 필드 조립
	- ARP Reply를 나타내는 '2'
	- 발신자 MAC 주소, IP 주소는 rt1인 자신의 주소
	- 목적지 MAC, IP 주소는 cl3 주소
5. cl3는 ARP Reply의 ARP 필드에 포함된 발신자 MAC, IP 주소를 보고 rt1의 MAC 주소를 인식, ARP 테이블에 기록해 임시로 저장함.
![[assets/images/34df885e5089455a01aa81e6f7c803ee_MD5.webp]]

6. cl3는 rt1의 MAC 주소를 이더넷 헤더의 목적지에 넣고 통신 시작

## ARP 캐시

- 모든 통신은 ARP에서 시작한다.
- 약점은 '브로드캐스트'를 전제로 함.
	- 처음엔 상대의 MAC 주소를 모르기 때문에 어쩔 수 없음.
- 캐시 기능 사용.
	- OS에 따라 다르지만 ARP 테이블(임시 메모리)에 저장하고 엔트리를 유지해서 유니캐스트 ARP를 사용해 도달 가능성을 확인 후 통신함.
	- 유니캐스트 ARP Request에 대한 ARP Reply를 받지 못하거나 ARP 항목이 삭제된 경우, 다시 브로드캐스트 ARP를 사용함.

![[assets/images/3ea5068a31491cff1a9cb3ef8e8c5c25_MD5.webp]]
