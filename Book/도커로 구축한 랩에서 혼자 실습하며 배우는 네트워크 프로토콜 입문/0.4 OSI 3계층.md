# OSI 3계층

## 환경

### 광대역 라우터

- LAN을 인터넷에 연결하기 위한 라우터
	- 인터넷에 연결하기 위한 WAN 포트
	- 가정 내 LAN을 연결하기 위한 LAN 포트
- 일반적으로 집에 있는 wifi 공유기
- 기능
	- 단말기에 네트워크 관련 설정을 배포(DHCP)
	- 인터넷 접속을 위한 IP 주소 변환(NAT)

### 인터넷 라우터

- 전 세계에 존재하는 무수히 많은 인터넷 라우터가 연결되어 있음
- 가정 LAN과 연결 가능 + 전 세계 인터넷 라우터 끼리 연결

![[Pasted image 20260116225223.png]]

## OSI 3계층(네트워크 계층)

- 이더넷이나 와이파이로 만들어진 네트워크를 연결하고, 서로 다른 네트워크에 있는 단말 과의 연결성을 보장하기 위한 계층
- 데이터 링크 계층에서 연결된 네트워크를 합쳐 큰 네트워크를 만들 수 있게 해줌

![[Pasted image 20260116225306.png]]

### 프로토콜

- IP(Internet Protocol): 데이터 교환에 사용
- ICMP(Internet Control Message Protocol): 문제 해결에 사용

#### IP(인터넷 프로토콜)

- IPv4, IPv6 두개 존재.
	- 호환 되지 않음.
- IP 패킷: IP로 캡슐화 된 패킷
	- IP 헤더: 여러 제어 정보. 단말을 식별하고 데이터를 세분화 하는 정보
	- IP 페이로드: 데이터 자체
![[Pasted image 20260117005256.png]]

##### IP 패킷 형식

![[Pasted image 20260117005346.png]]

- Tos(Type of Service)
	- IP 패킷의 우선순위를 나타내는 1바이트
	- 우선순위 제어, 대역폭 제어, 혼잡 제어 등의 QoS(Quality of Service)에서 사용
- 패킷 길이
	- IP 페더와 IP 페이로드를 합친 전체 패킷의 길이
	- 수신 단말은 이 필드를 보고 IP 패킷이 어디까지인지 알 수 있음.
	- 이더넷의 기본 MTU(Maximum Transmission Unit)를 가득 채운 IP 패킷의 경우, 패킷 길이 값은 '1500'(16진수로 05dc)임.
- 식별자
	- **IP 단편화**: IP 통신에서 데이터를 그대로 전송하는게 아니라 분할하여 전송함.
		- IP 패킷은 최대 MTU 까지만 데이터를 저장가능
		- 전송 계층에서 MTU보다 큰 데이터를 수신하거나 입구보다 출구 인터페이스의 MTU가 작을 경우 MTU에 맞게 데이터를 분할해야 함.
	- 식별자, 플래그, 프래그먼트 오프셋은 IP 단편화에 대한 정보를 담음.
	- 식별자는 패킷을 생성할 때 무작위의 ID이다.
- 플래그
	- 3비트로 구성
	- 첫번째 비트는 사용하지 않음.
	- 두번째 비트는 `DF`(Don't Fragment) 로, 패킷을 단편화 할 수 있는지 여부 나타냄
		- 0: 단편화 허용
		- 1: 단편화 허용 X
			- 단편화가 발생하면 처리 지연이 발생, 성능 저하
			- 최근 애플리케이션은 처리 지연을 고려, 단편화 허용하지 않도록 1로 설정해
			- 상위 계층(전송 ~ 애플리케이션 계층)에서 데이터 크기를 조정함
	- 세번째 피트는 `MF`(More Fragment)로, IP 패킷이 뒤따르는지 여부
		- 0: 단편화된 IPv4 패킷이 뒤따르지 않음
		- 1: 뒤따름
- 프래그먼트 오프셋
	- 단편화할 때 패킷이 윈래 패킷의 시작부터 어디쯤 위치하는지 나타내는 13 비트 필드
	- 수신 단말은 이걸보고 IP 패킷의 순서를 정렬함.
- TTL(Time to Live)
	- 패킷 수명을 나타내는 1바이트.
	- 패킷의 수명을 '경유하는 라우터 수'로 나타냄.
	- 경우하는 라우터 수를 '홉 수'라고 함.
	- TTL 값은 라우터를 통과할 때마다, 1씩 줄어 값이 '0'이 되면 폐기 된다.
		- IP 패킷을 폐기한 라우터는 Time-to-live Exceeded(유형 11/코드 0)이라는 ICMP 패킷을 반환해 패킷이 폐기했음을 발신 단말에 알림.
		- ![[Pasted image 20260117010844.png]]
		- TTL의 기본 값은 OS에 따라 다름.

| 제조사     | OS/버전          | TTL 기본값 |
| ------- | -------------- | ------- |
| 마이크로소프트 | Windows 10     | 128     |
| 마이크로소프트 | Windows 11     | 128     |
| 애플      | macOS 14       | 64      |
| 애플      | iOS 17.0.3     | 64      |
| 오픈소스    | Ubuntu 20.04   | 64      |
| 구글      | Android 11     | 64      |
| Cisco   | Cisco IOS 15.1 | 255     |

- 발신자/목적지 IP 주소
	- IP 주소: IP 네트워크에 연결된 단말을 나타내는 4바이트 식별ID
	- IP 네트워크의 주소와 같음.
	- PC나 서버의 NIC, 라우터, 방화벽, 관리형 L2 스위치 등 IP 네트워크에서 통신하는 모든 단말은 반드시 IP 주소를 가지고 있어야 함.
	- 또한 단말당 반드시 하나의 IP 주소만 가질 수 있는건 아님.
		- 장비의 종류와 용도에 따라 여러 개의 IP 주소를 가질 수 있음.
		- 라우터는 IP 네트워크를 연결하기 위해 각 포트마다 IP 주소를 가지고 있으며, 관리용으로만 제공되는 이더넷 관리 포트에도 IP 주소를 가지고 있다.
- 옵션
	- IP 패킷 전송 시 확장 기능을 저장하는 가변 길이의 필드.
	- 실무에서 거의 사용안함.
- 패딩
	- IP 헤더의 비트 수를 조정하는데 사용되는 필드.
	- IP 헤더는 사양상 4바이트 단위여아 함.
	- 옵션의 길이가 정해져 있지 않기 때문에 4바이트가 될 지 알 수 없으며, 4바이트의 정수 배가 되지 않는다면 끝에 패딩의 '0'을 부여하여 4바이트의 정수 배가 되도록 한다.

### IP 주소 및 서브넷 마스크

- IP 주소는 그 자체만으로 작동하지 않음.
- **서브넷 마스크**라는 또 다른 32비트 값과 함께 사용함.

IP 주소는 '네트워크 부분', '호스트 부분' 두 가지로 구성된다.
- 네트워크 부분: 어떤 IP 네트워크에 있는지
- 호스트 부분: 어떤 단말인지.
서브넷 마스크는 이 둘을 구분하는 표식 같은 것으로, '1' 비트는 네트워크 부분, '0' 비트는 호스트 부분을 나타냄. IP 주소와 서브넷 마사크를 조합해 '어느 IP' 네트워크에 있는 어느 단말인지 식별.

![[Pasted image 20260117154616.png]]

서브넷 마스크 표기법
- 10진수 표기
- CIDR(Classless Inter-Domain Routing) 표기
	- IP 주소와 서브넷 마스크를 함께 표현함.
		- IP 주소 뒤에 '/'(슬래시)
		- 서브넷 마스크(2진수)의 '1'의 개수를 표기
	- 예를들어, LAN에 있는 cl1의
		- IP 주소: 192.168.11.1,
		- 서브넷 마스크: 255.255.255.0
		- 이를 CIDR로 표기: 192.168.11.1/24
